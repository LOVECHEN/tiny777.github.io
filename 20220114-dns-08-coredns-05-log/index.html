

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="https://resource.tinychen.com/logos.png">
  <link rel="icon" href="https://resource.tinychen.com/logos.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="TinyChen">
  <meta name="keywords" content="">
  
    <meta name="description" content="本文主要用于介绍CoreDNS用来记录日志的几种方式以及在生产环境中遇到的一些问题和解决方案。">
<meta property="og:type" content="article">
<meta property="og:title" content="CoreDNS篇5-日志处理">
<meta property="og:url" content="https://tinychen.com/20220114-dns-08-coredns-05-log/index.html">
<meta property="og:site_name" content="TinyChen&#39;s Studio">
<meta property="og:description" content="本文主要用于介绍CoreDNS用来记录日志的几种方式以及在生产环境中遇到的一些问题和解决方案。">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://resource.tinychen.com/202201141619652.jpg">
<meta property="article:published_time" content="2022-01-14T03:00:00.000Z">
<meta property="article:modified_time" content="2022-01-14T03:00:00.000Z">
<meta property="article:author" content="TinyChen">
<meta property="article:tag" content="dns">
<meta property="article:tag" content="coredns">
<meta property="article:tag" content="dnstap">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://resource.tinychen.com/202201141619652.jpg">
  
  
  <title>CoreDNS篇5-日志处理 - TinyChen&#39;s Studio</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/prism/1.26.0/plugins/line-numbers/prism-line-numbers.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"tinychen.com","root":"/","version":"1.8.14","typing":{"enable":true,"typeSpeed":30,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"bash"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":1},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":"7a96963a1145ac7fde1442d739a11ffd","google":"UA-166769908-1","gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>

  
<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="TinyChen's Studio" type="application/atom+xml">
</head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>TinyChen</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archives
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                Categories
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                Tags
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                Links
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('https://resource.tinychen.com/202201141620356.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="CoreDNS篇5-日志处理"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-01-14 11:00" pubdate>
          January 14, 2022 am
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          19k words
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          159 mins
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">CoreDNS篇5-日志处理</h1>
            
              <p class="note note-info">
                
                  
                    Last updated on January 14, 2022 am
                  
                
              </p>
            
            <div class="markdown-body">
              
              <p>本文主要用于介绍CoreDNS用来记录日志的几种方式以及在生产环境中遇到的一些问题和解决方案。</p>
<span id="more"></span>


<h1 id="1、log插件"><a href="#1、log插件" class="headerlink" title="1、log插件"></a>1、log插件</h1><p>coredns的日志输出并不如nginx那么完善（并不能在配置文件中指定输出的文件目录，但是可以指定日志的格式），默认情况下不论是log插件还是error插件都会把所有的相关日志输出到程序的<code>standard output</code>中。使用systemd来管理coredns之后，默认情况下基本就是由<code>rsyslog</code>和<code>systemd-journald</code>这两个服务来管理日志。</p>
<h2 id="1-1-log插件配置"><a href="#1-1-log插件配置" class="headerlink" title="1.1 log插件配置"></a>1.1 log插件配置</h2><p>前面的文章里我们有简单的介绍过coredns的日志处理，对于log插件也是类似的操作。考虑到CentOS8已经结束支持，这里仅介绍CentOS7的配置方法，更高版本的<code>systemd</code>可以参考<a href="https://tinychen.com/20210509-dns-03-coredns-01-introduction/">之前的文章</a>。</p>
<p>对于centos7等系统而言，是不支持在高版本的systemd中的<code>unit</code>文件中使用<code>append</code>和<code>file</code>两个参数的，并且对于这种方式输出的日志缺少了前面的时间和主机名等信息，相对而言还是修改rsyslog的方式要更加的可靠。那么在开启了<code>rsyslog.service</code>服务的情况下，日志就会输出到<code>/var/log/messages</code>文件中，或者可以使用<code>journalctl -u coredns</code>命令来查看全部的日志。</p>
<p>如果想要将coredns的日志全部集中到一个文件进行统一管理，我们可以对负责管理<code>systemd</code>的日志的<code>rsyslog</code>服务的配置进行修改，然后再重启rsyslog服务即可生效。</p>
<div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 注意这段配置需要添加在其他日志配置规则之前</span>
<span class="token comment"># 否则日志会在/var/log/messages和/home/coredns/logs/coredns.log都写入一份</span>
$ <span class="token function">vim</span> /etc/rsyslog.conf
<span class="token keyword">if</span> <span class="token variable">$programname</span> <span class="token operator">==</span> <span class="token string">'coredns'</span> <span class="token keyword">then</span> /home/coredns/logs/coredns.log
<span class="token operator">&amp;</span> stop

$ systemctl restart rsyslog.service<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>



<p>但是有两点需要额外注意：</p>
<ul>
<li><strong>CoreDNS在开启日志记录之后的性能要差于不开启日志记录</strong>，这个很容易理解，因为记录日志需要耗费额外的资源，尤其是当QPS增大之后，记录日志组件的压力也会增大，需要注意两个服务对资源的抢占和分配是否合理；如果遇到写入日志占用大量资源的情况，可以考虑将其配置为<a target="_blank" rel="noopener" href="https://coredns.io/plugins/log/#syntax">只写入部分类型日志</a>（如只写入错误日志）</li>
<li><code>rsyslog</code>和<code>systemd-journald</code>这两个服务<strong>默认情况下都会对日志的写入频率进行限制</strong>，当QPS增大之后，记录的日志会不完整；当然这个问题可以通过调整rsyslog的参数解决</li>
</ul>
<h2 id="1-2-rsyslog配置"><a href="#1-2-rsyslog配置" class="headerlink" title="1.2 rsyslog配置"></a>1.2 rsyslog配置</h2><p>下面具体介绍一下如何配置<code>rsyslog</code>和<code>systemd-journald</code>解除相关的日志限制。</p>
<p>默认情况下我们查看<code>systemd-journald.service</code>的日志或者是查看<code>/var/log/messages</code>文件，如果看到类似下面的提示信息，就说明日志的输出频率太高被抑制了</p>
<div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ systemctl status systemd-journald.service
● systemd-journald.service - Journal Service
   Loaded: loaded <span class="token punctuation">(</span>/usr/lib/systemd/system/systemd-journald.service<span class="token punctuation">;</span> static<span class="token punctuation">;</span> vendor preset: disabled<span class="token punctuation">)</span>
   Active: active <span class="token punctuation">(</span>running<span class="token punctuation">)</span> since Wed <span class="token number">2021</span>-12-01 09:30:03 CST<span class="token punctuation">;</span> <span class="token number">3</span> weeks <span class="token number">6</span> days ago
     Docs: man:systemd-journald.service<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span>
           man:journald.conf<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
 Main PID: <span class="token number">709</span> <span class="token punctuation">(</span>systemd-journal<span class="token punctuation">)</span>
   Status: <span class="token string">"Processing requests..."</span>
   CGroup: /system.slice/systemd-journald.service
           └─709 /usr/lib/systemd/systemd-journald

Dec <span class="token number">28</span> <span class="token number">15</span>:36:27 tiny-server systemd-journal<span class="token punctuation">[</span><span class="token number">709</span><span class="token punctuation">]</span>: Suppressed <span class="token number">13174</span> messages from /system.slice/coredns.service
Dec <span class="token number">28</span> <span class="token number">15</span>:36:57 tiny-server systemd-journal<span class="token punctuation">[</span><span class="token number">709</span><span class="token punctuation">]</span>: Suppressed <span class="token number">13185</span> messages from /system.slice/coredns.service
Dec <span class="token number">28</span> <span class="token number">15</span>:37:27 tiny-server systemd-journal<span class="token punctuation">[</span><span class="token number">709</span><span class="token punctuation">]</span>: Suppressed <span class="token number">11600</span> messages from /system.slice/coredns.service
Dec <span class="token number">28</span> <span class="token number">15</span>:37:57 tiny-server systemd-journal<span class="token punctuation">[</span><span class="token number">709</span><span class="token punctuation">]</span>: Suppressed <span class="token number">13896</span> messages from /system.slice/coredns.service
Dec <span class="token number">28</span> <span class="token number">15</span>:38:27 tiny-server systemd-journal<span class="token punctuation">[</span><span class="token number">709</span><span class="token punctuation">]</span>: Suppressed <span class="token number">13653</span> messages from /system.slice/coredns.service
Dec <span class="token number">28</span> <span class="token number">15</span>:38:57 tiny-server systemd-journal<span class="token punctuation">[</span><span class="token number">709</span><span class="token punctuation">]</span>: Suppressed <span class="token number">16503</span> messages from /system.slice/coredns.service
Dec <span class="token number">28</span> <span class="token number">15</span>:39:27 tiny-server systemd-journal<span class="token punctuation">[</span><span class="token number">709</span><span class="token punctuation">]</span>: Suppressed <span class="token number">13300</span> messages from /system.slice/coredns.service
Dec <span class="token number">28</span> <span class="token number">15</span>:39:57 tiny-server systemd-journal<span class="token punctuation">[</span><span class="token number">709</span><span class="token punctuation">]</span>: Suppressed <span class="token number">10491</span> messages from /system.slice/coredns.service
Dec <span class="token number">28</span> <span class="token number">15</span>:40:27 tiny-server systemd-journal<span class="token punctuation">[</span><span class="token number">709</span><span class="token punctuation">]</span>: Suppressed <span class="token number">12079</span> messages from /system.slice/coredns.service
Dec <span class="token number">28</span> <span class="token number">15</span>:40:57 tiny-server systemd-journal<span class="token punctuation">[</span><span class="token number">709</span><span class="token punctuation">]</span>: Suppressed <span class="token number">17182</span> messages from /system.slice/coredns.service

$ <span class="token function">tail</span> -f /var/log/messages
Dec <span class="token number">28</span> <span class="token number">15</span>:43:55 tiny-server rsyslogd: imjournal: begin to drop messages due to rate-limiting<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>
<p>解决方案也比较简单，我们对这两个服务的配置参数进行调整，将限制日志写入频率和写入时间间隔都设为0（即不做限制），然后重启服务即可。</p>
<div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">echo</span> <span class="token string">"RateLimitInterval=0"</span> <span class="token operator">>></span> /etc/systemd/journald.conf
<span class="token builtin class-name">echo</span> <span class="token string">"RateLimitBurst=0"</span> <span class="token operator">>></span> /etc/systemd/journald.conf
systemctl restart systemd-journald.service 

<span class="token builtin class-name">echo</span> <span class="token string">"\<span class="token variable">$imjournalRatelimitInterval</span> 0"</span> <span class="token operator">>></span> /etc/rsyslog.conf
<span class="token builtin class-name">echo</span> <span class="token string">"\<span class="token variable">$imjournalRatelimitBurst</span> 0"</span> <span class="token operator">>></span> /etc/rsyslog.conf
systemctl restart rsyslog.service<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>

<p>需要特别注意的是：上述两个参数对所有使用rsyslog的服务都会生效，如果有其他大量写入日志的服务，建议调整日志文件输出目录，同时关注<code>/var/log</code>等目录的硬盘空间情况。</p>
<h1 id="2、dnstap插件"><a href="#2、dnstap插件" class="headerlink" title="2、dnstap插件"></a>2、dnstap插件</h1><p>CoreDNS的原生日志功能对于一个DNS服务器的绝大部分应用场景来说是足够使用的，如果有更进阶的需求，可以考虑使用<code>dnstap</code>插件来实现。</p>
<p>dnstap是一个基于谷歌的缓冲区协议（Protocol buffers）实现的用于DNS的灵活的、结构化的、二进制日志格式记录软件，目前已经获得了bind9、unbound、coredns、knot等几乎所有主流dns软件的支持。dnstap目前支持二进制日志格式、text日志格式、yaml日志格式和json日志格式。</p>
<p>CoreDNS官网对于<a target="_blank" rel="noopener" href="https://coredns.io/plugins/dnstap/">dnstap插件的介绍</a>比较简单，不过<a target="_blank" rel="noopener" href="https://dnstap.info/">官网页面</a>有比较详细的介绍。</p>
<blockquote>
<p><code>dnstap</code> is a flexible, structured binary log format for DNS software. It uses <a target="_blank" rel="noopener" href="https://developers.google.com/protocol-buffers/">Protocol Buffers</a> to encode events that occur inside DNS software in an implementation-neutral format.</p>
<p>Currently <code>dnstap</code> can only encode wire-format DNS messages. It is planned to support additional types of DNS log information.</p>
</blockquote>
<blockquote>
<p>Protocol buffers are Google’s language-neutral, platform-neutral, extensible mechanism for serializing structured data – think XML, but smaller, faster, and simpler. You define how you want your data to be structured once, then you can use special generated source code to easily write and read your structured data to and from a variety of data streams and using a variety of languages.</p>
<p>缓冲区协议（Protocol buffers）是 Google 用于序列化结构数据的语言中立、平台中立、可扩展机制。可以将其和XML相对比，但Protocol buffers更小、更快、更简单。 使用者只需定义一次数据的结构化方式，然后就可以使用特殊生成的源代码轻松地将结构化数据写入和读取各种数据流，并使用各种语言。</p>
</blockquote>
<p>这里需要额外注意的是：</p>
<ul>
<li><strong>dnstap和CoreDNS原生的log等日志记录插件可以同时使用</strong></li>
<li>尽管CoreDNS默认内置dnstap插件，但是要使用dnstap还是需要我们自己手动安装dnstap，再到corefile中配置dnstap的socket路径或者通信端口才能使用</li>
</ul>
<h2 id="2-1-dnstap安装"><a href="#2-1-dnstap安装" class="headerlink" title="2.1 dnstap安装"></a>2.1 dnstap安装</h2><p>dnstap官方在github上面开源了一个<a target="_blank" rel="noopener" href="https://github.com/dnstap/golang-dnstap">golang-dnstap</a>的项目，可以使用go来快速安装dnstap</p>
<div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># golang的安装配置比较简单，我们从https://go.dev/dl/直接下载最新的稳定版本即可。</span>
<span class="token function">wget</span> https://go.dev/dl/go1.17.5.linux-amd64.tar.gz
<span class="token function">tar</span> -zxvf go1.17.5.linux-amd64.tar.gz -C /usr/local

<span class="token comment"># 修改系统默认的go文件</span>
<span class="token function">ln</span> -s /usr/local/go/bin/go /usr/bin/go

<span class="token comment"># 接下来的go环境变量同学们可以根据自己的实际需求进行配置。</span>
<span class="token comment"># 对于我个人而言，我直接在/etc/profile中添加下面的配置然后source生效即可。</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">GOROOT</span><span class="token operator">=</span>/usr/local/go
<span class="token builtin class-name">export</span> <span class="token assign-left variable">GOBIN</span><span class="token operator">=</span><span class="token variable">$GOROOT</span>/bin
<span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token environment constant">$PATH</span><span class="token builtin class-name">:</span><span class="token variable">$GOBIN</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">GOPATH</span><span class="token operator">=</span>/home/gopath<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>

<p>执行<code>go version</code>命令确定go安装无误之后就可以直接安装dnstap：</p>
<div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 接着就可以使用go命令来快速安装dnstap</span>
go get -u github.com/dnstap/golang-dnstap/dnstap

<span class="token comment"># go版本高于v1.16建议使用下面这条指令</span>
<span class="token comment"># 关于go get和go install的区别可以查看go的官方文档https://golang.org/doc/go-get-install-deprecation</span>
go <span class="token function">install</span> github.com/dnstap/golang-dnstap/dnstap@latest
   
<span class="token comment"># 如果不确定是否安装成功，可以执行下面的命令查看安装信息进行确定</span>
<span class="token punctuation">[</span>root@coredns2 home<span class="token punctuation">]</span><span class="token comment"># dnstap --help</span>
Usage: dnstap <span class="token punctuation">[</span>OPTION<span class="token punctuation">]</span><span class="token punctuation">..</span>.
  -T value
        <span class="token function">write</span> dnstap payloads to tcp/ip address
  -U value
        <span class="token function">write</span> dnstap payloads to unix socket
  -a    append to the given file, <span class="token keyword">do</span> not overwrite. valid only when outputting a text or YAML file.
  -j    use verbose JSON output
  -l value
        <span class="token builtin class-name">read</span> dnstap payloads from tcp/ip
  -q    use quiet text output
  -r value
        <span class="token builtin class-name">read</span> dnstap payloads from <span class="token function">file</span>
  -t duration
        I/O <span class="token function">timeout</span> <span class="token keyword">for</span> tcp/ip and unix domain sockets
  -u value
        <span class="token builtin class-name">read</span> dnstap payloads from unix socket
  -w string
        <span class="token function">write</span> output to <span class="token function">file</span>
  -y    use verbose YAML output

Quiet text output <span class="token function">format</span> mnemonics:
    AQ: AUTH_QUERY
    AR: AUTH_RESPONSE
    RQ: RESOLVER_QUERY
    RR: RESOLVER_RESPONSE
    CQ: CLIENT_QUERY
    CR: CLIENT_RESPONSE
    FQ: FORWARDER_QUERY
    FR: FORWARDER_RESPONSE
    SQ: STUB_QUERY
    SR: STUB_RESPONSE
    TQ: TOOL_QUERY
    TR: TOOL_RESPONSE<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>

<h2 id="2-2-coredns配置"><a href="#2-2-coredns配置" class="headerlink" title="2.2 coredns配置"></a>2.2 coredns配置</h2><p>coredns中对dnstap的配置非常简单，可以选择配置<strong>socket通信</strong>或者是<strong>tcp通信</strong>，<code>full</code>参数则是可以记录更多的参数信息，如同样的一次查询，红框是开启了<code>full</code>参数，而绿框则是不开启，两者相差较大。</p>
<div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 使用tcp通信</span>
dnstap tcp://127.0.0.1:6000 full
<span class="token comment"># 使用socket通信</span>
dnstap unix:///tmp/dnstap.sock full<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></div>

<p><img src="https://resource.tinychen.com/202201121704374.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="2-3-dnstap配置"><a href="#2-3-dnstap配置" class="headerlink" title="2.3 dnstap配置"></a>2.3 dnstap配置</h2><p>dnstap的配置也比较简单，基本可以分为三个部分：</p>
<ul>
<li>指定通信方式：如<code>-u /tmp/dnstap.sock</code>或者<code>-l 127.0.0.1:6000</code></li>
<li>指定日志文件：如<code>-w /home/coredns/logs/dnstap.log</code></li>
<li>指定日志格式：默认为二进制格式，<code>-q</code>为<code>text文本</code>，<code>-y</code>为<code>yaml格式</code>，<code>-j</code>为<code>json格式</code></li>
<li>其他参数：如<code>-a</code>追加写入内容到日志文件中而非覆盖原有的文件</li>
</ul>
<div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 使用socket通信，并以默认的二进制格式记录到/home/coredns/logs/dnstap.log文件中</span>
dnstap -u /tmp/dnstap.sock -w /home/coredns/logs/dnstap.log
<span class="token comment"># 此时无法直接查看日志文件中的内容</span>
$ <span class="token function">tail</span> -f /home/coredns/logs/dnstap.log
<span class="token string">"protobuf:dnstap.Dnstap
^C

# 使用socket通信，并以text文本格式追加记录到/home/coredns/logs/dnstap.log文件中
dnstap -u /tmp/dnstap.sock -w /home/coredns/logs/dnstap.log -q -a
# 这里的coredns对tinychen.com的查询会forward出去，
# 因此日志中会有CLIENT_QUERY CLIENT_RESPONSE FORWARDER_QUERY FORWARDER_RESPONSE四条记录
$ tail -f /home/coredns/logs/dnstap.log
16:14:39.329430 CQ 10.31.100.100 UDP 53b "</span>tinychen.com.<span class="token string">" IN A
16:14:39.329546 FQ 127.0.0.1 UDP 53b "</span>tinychen.com.<span class="token string">" IN A
16:14:39.330241 FR 127.0.0.1 UDP 69b "</span>tinychen.com.<span class="token string">" IN A
16:14:39.330441 CR 10.31.100.100 UDP 81b "</span>tinychen.com.<span class="token string">" IN A




# 使用socket通信，并以yaml格式追加记录到/home/coredns/logs/dnstap.log文件中
dnstap -u /tmp/dnstap.sock -w /home/coredns/logs/dnstap.log -y -a
# 这里的coredns对tinychen.com的查询会forward出去，
# 因此日志中会有CLIENT_QUERY CLIENT_RESPONSE FORWARDER_QUERY FORWARDER_RESPONSE四条记录
$ tail -f /home/coredns/logs/dnstap.log
type: MESSAGE
message:
  type: CLIENT_QUERY
  query_time: !!timestamp 2022-01-12 08:23:25.211126656
  socket_family: INET
  socket_protocol: UDP
  query_address: 10.31.100.100
  query_port: 58562
  query_message: |
    ;; opcode: QUERY, status: NOERROR, id: 30286
    ;; flags: rd ad; QUERY: 1, ANSWER: 0, AUTHORITY: 0, ADDITIONAL: 1

    ;; QUESTION SECTION:
    ;tinychen.com.      IN       A

    ;; ADDITIONAL SECTION:

    ;; OPT PSEUDOSECTION:
    ; EDNS: version 0; flags: ; udp: 4096
    ; COOKIE: 22c8a1e55b27c1b9
---
type: MESSAGE
message:
  type: FORWARDER_QUERY
  query_time: !!timestamp 2022-01-12 08:23:25.211208675
  socket_family: INET
  socket_protocol: UDP
  query_address: 10.31.100.100
  response_address: 127.0.0.1
  query_port: 58562
  response_port: 35353
  query_message: |
    ;; opcode: QUERY, status: NOERROR, id: 30286
    ;; flags: rd ad; QUERY: 1, ANSWER: 0, AUTHORITY: 0, ADDITIONAL: 1

    ;; QUESTION SECTION:
    ;tinychen.com.      IN       A

    ;; ADDITIONAL SECTION:

    ;; OPT PSEUDOSECTION:
    ; EDNS: version 0; flags: do; udp: 2048
    ; COOKIE: 22c8a1e55b27c1b9
---
type: MESSAGE
message:
  type: FORWARDER_RESPONSE
  query_time: !!timestamp 2022-01-12 08:23:25.211208675
  response_time: !!timestamp 2022-01-12 08:23:25.243335638
  socket_family: INET
  socket_protocol: UDP
  query_address: 10.31.100.100
  response_address: 127.0.0.1
  query_port: 58562
  response_port: 35353
  response_message: |
    ;; opcode: QUERY, status: NOERROR, id: 30286
    ;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

    ;; QUESTION SECTION:
    ;tinychen.com.      IN       A

    ;; ANSWER SECTION:
    tinychen.com.       589     IN      A       1.12.217.55

    ;; ADDITIONAL SECTION:

    ;; OPT PSEUDOSECTION:
    ; EDNS: version 0; flags: do; udp: 1232
---
type: MESSAGE
message:
  type: CLIENT_RESPONSE
  query_time: !!timestamp 2022-01-12 08:23:25.211126656
  response_time: !!timestamp 2022-01-12 08:23:25.243503207
  socket_family: INET
  socket_protocol: UDP
  query_address: 10.31.100.100
  query_port: 58562
  response_message: |
    ;; opcode: QUERY, status: NOERROR, id: 30286
    ;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

    ;; QUESTION SECTION:
    ;tinychen.com.      IN       A

    ;; ANSWER SECTION:
    tinychen.com.       589     IN      A       1.12.217.55

    ;; ADDITIONAL SECTION:

    ;; OPT PSEUDOSECTION:
    ; EDNS: version 0; flags: ; udp: 4096
    ; COOKIE: 22c8a1e55b27c1b9
---




# 使用socket通信，并以yaml格式追加记录到/home/coredns/logs/dnstap.log文件中
dnstap -u /tmp/dnstap.sock -w /home/coredns/logs/dnstap.log -j -a
# 这里的coredns对tinychen.com的查询会forward出去，
# 因此日志中会有CLIENT_QUERY CLIENT_RESPONSE FORWARDER_QUERY FORWARDER_RESPONSE四条记录
$ tail -f /home/coredns/logs/dnstap.log
&#123;"</span><span class="token builtin class-name">type</span><span class="token string">":"</span>MESSAGE<span class="token string">","</span>message<span class="token string">":&#123;"</span><span class="token builtin class-name">type</span><span class="token string">":"</span>CLIENT_QUERY<span class="token string">","</span>query_time<span class="token string">":"</span><span class="token number">2022</span>-01-12T08:36:41.745130199Z<span class="token string">","</span>socket_family<span class="token string">":"</span>INET<span class="token string">","</span>socket_protocol<span class="token string">":"</span>UDP<span class="token string">","</span>query_address<span class="token string">":"</span><span class="token number">10.31</span>.100.100<span class="token string">","</span>query_port<span class="token string">":58561,"</span>query_message<span class="token string">":"</span><span class="token punctuation">;</span><span class="token punctuation">;</span> opcode: QUERY, status: NOERROR, id: <span class="token number">5835</span><span class="token punctuation">\</span>n<span class="token punctuation">;</span><span class="token punctuation">;</span> flags: rd ad<span class="token punctuation">;</span> QUERY: <span class="token number">1</span>, ANSWER: <span class="token number">0</span>, AUTHORITY: <span class="token number">0</span>, ADDITIONAL: <span class="token number">1</span><span class="token punctuation">\</span>n<span class="token punctuation">\</span>n<span class="token punctuation">;</span><span class="token punctuation">;</span> QUESTION SECTION:<span class="token punctuation">\</span>n<span class="token punctuation">;</span>tinychen.com.<span class="token punctuation">\</span>tIN<span class="token punctuation">\</span>t A<span class="token punctuation">\</span>n<span class="token punctuation">\</span>n<span class="token punctuation">;</span><span class="token punctuation">;</span> ADDITIONAL SECTION:<span class="token punctuation">\</span>n<span class="token punctuation">\</span>n<span class="token punctuation">;</span><span class="token punctuation">;</span> OPT PSEUDOSECTION:<span class="token punctuation">\</span>n<span class="token punctuation">;</span> EDNS: version <span class="token number">0</span><span class="token punctuation">;</span> flags: <span class="token punctuation">;</span> udp: <span class="token number">4096</span><span class="token punctuation">\</span>n<span class="token punctuation">;</span> COOKIE: fd6716688b43710a<span class="token punctuation">\</span>n<span class="token string">"&#125;&#125;
&#123;"</span><span class="token builtin class-name">type</span><span class="token string">":"</span>MESSAGE<span class="token string">","</span>message<span class="token string">":&#123;"</span><span class="token builtin class-name">type</span><span class="token string">":"</span>FORWARDER_QUERY<span class="token string">","</span>query_time<span class="token string">":"</span><span class="token number">2022</span>-01-12T08:36:41.745243809Z<span class="token string">","</span>socket_family<span class="token string">":"</span>INET<span class="token string">","</span>socket_protocol<span class="token string">":"</span>UDP<span class="token string">","</span>query_address<span class="token string">":"</span><span class="token number">10.31</span>.100.100<span class="token string">","</span>response_address<span class="token string">":"</span><span class="token number">127.0</span>.0.1<span class="token string">","</span>query_port<span class="token string">":58561,"</span>response_port<span class="token string">":35353,"</span>query_message<span class="token string">":"</span><span class="token punctuation">;</span><span class="token punctuation">;</span> opcode: QUERY, status: NOERROR, id: <span class="token number">5835</span><span class="token punctuation">\</span>n<span class="token punctuation">;</span><span class="token punctuation">;</span> flags: rd ad<span class="token punctuation">;</span> QUERY: <span class="token number">1</span>, ANSWER: <span class="token number">0</span>, AUTHORITY: <span class="token number">0</span>, ADDITIONAL: <span class="token number">1</span><span class="token punctuation">\</span>n<span class="token punctuation">\</span>n<span class="token punctuation">;</span><span class="token punctuation">;</span> QUESTION SECTION:<span class="token punctuation">\</span>n<span class="token punctuation">;</span>tinychen.com.<span class="token punctuation">\</span>tIN<span class="token punctuation">\</span>t A<span class="token punctuation">\</span>n<span class="token punctuation">\</span>n<span class="token punctuation">;</span><span class="token punctuation">;</span> ADDITIONAL SECTION:<span class="token punctuation">\</span>n<span class="token punctuation">\</span>n<span class="token punctuation">;</span><span class="token punctuation">;</span> OPT PSEUDOSECTION:<span class="token punctuation">\</span>n<span class="token punctuation">;</span> EDNS: version <span class="token number">0</span><span class="token punctuation">;</span> flags: <span class="token keyword">do</span><span class="token punctuation">;</span> udp: <span class="token number">2048</span><span class="token punctuation">\</span>n<span class="token punctuation">;</span> COOKIE: fd6716688b43710a<span class="token punctuation">\</span>n<span class="token string">"&#125;&#125;
&#123;"</span><span class="token builtin class-name">type</span><span class="token string">":"</span>MESSAGE<span class="token string">","</span>message<span class="token string">":&#123;"</span><span class="token builtin class-name">type</span><span class="token string">":"</span>FORWARDER_RESPONSE<span class="token string">","</span>query_time<span class="token string">":"</span><span class="token number">2022</span>-01-12T08:36:41.745243809Z<span class="token string">","</span>response_time<span class="token string">":"</span><span class="token number">2022</span>-01-12T08:36:41.83691354Z<span class="token string">","</span>socket_family<span class="token string">":"</span>INET<span class="token string">","</span>socket_protocol<span class="token string">":"</span>UDP<span class="token string">","</span>query_address<span class="token string">":"</span><span class="token number">10.31</span>.100.100<span class="token string">","</span>response_address<span class="token string">":"</span><span class="token number">127.0</span>.0.1<span class="token string">","</span>query_port<span class="token string">":58561,"</span>response_port<span class="token string">":35353,"</span>response_message<span class="token string">":"</span><span class="token punctuation">;</span><span class="token punctuation">;</span> opcode: QUERY, status: SERVFAIL, id: <span class="token number">5835</span><span class="token punctuation">\</span>n<span class="token punctuation">;</span><span class="token punctuation">;</span> flags: qr rd ra<span class="token punctuation">;</span> QUERY: <span class="token number">1</span>, ANSWER: <span class="token number">0</span>, AUTHORITY: <span class="token number">0</span>, ADDITIONAL: <span class="token number">1</span><span class="token punctuation">\</span>n<span class="token punctuation">\</span>n<span class="token punctuation">;</span><span class="token punctuation">;</span> QUESTION SECTION:<span class="token punctuation">\</span>n<span class="token punctuation">;</span>tinychen.com.<span class="token punctuation">\</span>tIN<span class="token punctuation">\</span>t A<span class="token punctuation">\</span>n<span class="token punctuation">\</span>n<span class="token punctuation">;</span><span class="token punctuation">;</span> ADDITIONAL SECTION:<span class="token punctuation">\</span>n<span class="token punctuation">\</span>n<span class="token punctuation">;</span><span class="token punctuation">;</span> OPT PSEUDOSECTION:<span class="token punctuation">\</span>n<span class="token punctuation">;</span> EDNS: version <span class="token number">0</span><span class="token punctuation">;</span> flags: <span class="token keyword">do</span><span class="token punctuation">;</span> udp: <span class="token number">1232</span><span class="token punctuation">\</span>n<span class="token string">"&#125;&#125;
&#123;"</span><span class="token builtin class-name">type</span><span class="token string">":"</span>MESSAGE<span class="token string">","</span>message<span class="token string">":&#123;"</span><span class="token builtin class-name">type</span><span class="token string">":"</span>CLIENT_RESPONSE<span class="token string">","</span>query_time<span class="token string">":"</span><span class="token number">2022</span>-01-12T08:36:41.745130199Z<span class="token string">","</span>response_time<span class="token string">":"</span><span class="token number">2022</span>-01-12T08:36:41.837144129Z<span class="token string">","</span>socket_family<span class="token string">":"</span>INET<span class="token string">","</span>socket_protocol<span class="token string">":"</span>UDP<span class="token string">","</span>query_address<span class="token string">":"</span><span class="token number">10.31</span>.100.100<span class="token string">","</span>query_port<span class="token string">":58561,"</span>response_message<span class="token string">":"</span><span class="token punctuation">;</span><span class="token punctuation">;</span> opcode: QUERY, status: SERVFAIL, id: <span class="token number">5835</span><span class="token punctuation">\</span>n<span class="token punctuation">;</span><span class="token punctuation">;</span> flags: qr rd ra<span class="token punctuation">;</span> QUERY: <span class="token number">1</span>, ANSWER: <span class="token number">0</span>, AUTHORITY: <span class="token number">0</span>, ADDITIONAL: <span class="token number">1</span><span class="token punctuation">\</span>n<span class="token punctuation">\</span>n<span class="token punctuation">;</span><span class="token punctuation">;</span> QUESTION SECTION:<span class="token punctuation">\</span>n<span class="token punctuation">;</span>tinychen.com.<span class="token punctuation">\</span>tIN<span class="token punctuation">\</span>t A<span class="token punctuation">\</span>n<span class="token punctuation">\</span>n<span class="token punctuation">;</span><span class="token punctuation">;</span> ADDITIONAL SECTION:<span class="token punctuation">\</span>n<span class="token punctuation">\</span>n<span class="token punctuation">;</span><span class="token punctuation">;</span> OPT PSEUDOSECTION:<span class="token punctuation">\</span>n<span class="token punctuation">;</span> EDNS: version <span class="token number">0</span><span class="token punctuation">;</span> flags: <span class="token punctuation">;</span> udp: <span class="token number">4096</span><span class="token punctuation">\</span>n<span class="token punctuation">;</span> COOKIE: fd6716688b43710a<span class="token punctuation">\</span>n"<span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>



<h2 id="2-4-其他问题"><a href="#2-4-其他问题" class="headerlink" title="2.4 其他问题"></a>2.4 其他问题</h2><p>目前在使用dnstap的过程中发现了两个小问题：</p>
<ul>
<li><p>dnstap日志记录时间使用的是UTC时间记录，对于国内的用户，时间上就有八个小时的差距</p>
</li>
<li><p>dnstap限制缓冲区的消息条数为10000条，超出限制的消息不会被写入dnstap中</p>
<div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">Jan 13 20:41:56 coredns2 coredns: [WARNING] plugin&#x2F;dnstap: Dropped dnstap messages: 196
Jan 13 20:41:56 coredns2 coredns: [WARNING] plugin&#x2F;dnstap: Dropped dnstap messages: 680
Jan 13 20:41:58 coredns2 coredns: [WARNING] plugin&#x2F;dnstap: Dropped dnstap messages: 1900
Jan 13 20:41:58 coredns2 coredns: [WARNING] plugin&#x2F;dnstap: Dropped dnstap messages: 10118
Jan 13 20:41:59 coredns2 coredns: [WARNING] plugin&#x2F;dnstap: Dropped dnstap messages: 1472
Jan 13 20:41:59 coredns2 coredns: [WARNING] plugin&#x2F;dnstap: Dropped dnstap messages: 9430
Jan 13 20:42:02 coredns2 coredns: [WARNING] plugin&#x2F;dnstap: Dropped dnstap messages: 3669
Jan 13 20:42:02 coredns2 coredns: [WARNING] plugin&#x2F;dnstap: Dropped dnstap messages: 23351
Jan 13 20:42:06 coredns2 coredns: [WARNING] plugin&#x2F;dnstap: Dropped dnstap messages: 5776
Jan 13 20:42:06 coredns2 coredns: [WARNING] plugin&#x2F;dnstap: Dropped dnstap messages: 35511
Jan 13 20:42:17 coredns2 coredns: [WARNING] plugin&#x2F;dnstap: Dropped dnstap messages: 13161
Jan 13 20:42:17 coredns2 coredns: [WARNING] plugin&#x2F;dnstap: Dropped dnstap messages: 81395
Jan 13 20:42:41 coredns2 coredns: [WARNING] plugin&#x2F;dnstap: Dropped dnstap messages: 29500
Jan 13 20:42:41 coredns2 coredns: [WARNING] plugin&#x2F;dnstap: Dropped dnstap messages: 180877<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>

<p>如果想要突破这个限制，可以考虑在编译的时候修改源码</p>
<div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># github地址</span>
<span class="token comment"># https://github.com/coredns/coredns/blob/master/plugin/dnstap/io.go</span>

const <span class="token punctuation">(</span>
	tcpWriteBufSize <span class="token operator">=</span> <span class="token number">1024</span> * <span class="token number">1024</span> // there is no good explanation <span class="token keyword">for</span> why this number has this value.
	queueSize       <span class="token operator">=</span> <span class="token number">10000</span>       // idem.

	tcpTimeout   <span class="token operator">=</span> <span class="token number">4</span> * time.Second
	flushTimeout <span class="token operator">=</span> <span class="token number">1</span> * time.Second
<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div></li>
</ul>
<h1 id="3、errors插件"><a href="#3、errors插件" class="headerlink" title="3、errors插件"></a>3、errors插件</h1><h2 id="3-1-errors插件简介"><a href="#3-1-errors插件简介" class="headerlink" title="3.1 errors插件简介"></a>3.1 errors插件简介</h2><p>CoreDNS官方有对errors插件比较详细的<a target="_blank" rel="noopener" href="https://coredns.io/plugins/errors/">介绍和使用说明</a>，简单来说errors插件就是专门用来记录错误信息日志的一个组件。这里需要注意的是：</p>
<ul>
<li>并不是不使用errors插件，日志中就不会输出<code>[ERROR]</code>级别的日志；其他的插件和CoreDNS本身也是可以输出<code>[ERROR]</code>级别的日志</li>
<li>errors插件默认情况下输出的日志级别都是<code>[ERROR]</code>，但是也可以通过<code>consolidate</code>命令进行定义</li>
</ul>
<h2 id="3-2-errors插件配置"><a href="#3-2-errors插件配置" class="headerlink" title="3.2 errors插件配置"></a>3.2 errors插件配置</h2><p>errors的配置非常简单，位置和log插件一样</p>
<div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">.:53 &#123;
    forward . 127.0.0.1:35353
    log
    errors
    cache &#123;
        success 10240 600 60
        denial 5120 60 5
    &#125;
&#125;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>

<p>开启前后的对比如下：</p>
<div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 不开启error插件</span>
Jan <span class="token number">14</span> <span class="token number">11</span>:50:12 coredns2 coredns: <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token number">10.31</span>.53.2:36586 - <span class="token number">34882</span> <span class="token string">"A IN tinychen.com. udp 38 false 4096"</span> - - <span class="token number">0</span> <span class="token number">1</span>.001413555s

<span class="token comment"># 开启error插件</span>
Jan <span class="token number">14</span> <span class="token number">11</span>:50:33 coredns2 coredns: <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token number">10.31</span>.53.2:33796 - <span class="token number">62387</span> <span class="token string">"A IN tinychen.com. udp 38 false 4096"</span> - - <span class="token number">0</span> <span class="token number">1</span>.001076641s
Jan <span class="token number">14</span> <span class="token number">11</span>:50:33 coredns2 coredns: <span class="token punctuation">[</span>ERROR<span class="token punctuation">]</span> plugin/errors: <span class="token number">2</span> tinychen.com. A: <span class="token builtin class-name">read</span> udp <span class="token number">127.0</span>.0.1:57591-<span class="token operator">></span><span class="token number">127.0</span>.0.1:35353: read: connection refused<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>

<p>当然还可以有类似正则的配置方式可以简化日志输出，同时定义</p>
<div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">errors <span class="token punctuation">&#123;</span>
    consolidate 30s <span class="token string">".* connection refused$"</span> warning
    consolidate 5m <span class="token string">".* i/o timeout$"</span> warning
    consolidate 30s <span class="token string">"^Failed to .+"</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>

<p>这样子可以把多条错误日志合并输出，结果如下：</p>
<div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 合并错误日志之前，每次错误日志都会单独输出，日志级别默认均为[ERROR]</span>
Jan <span class="token number">14</span> <span class="token number">14</span>:29:31 coredns2 coredns: <span class="token punctuation">[</span>ERROR<span class="token punctuation">]</span> plugin/errors: <span class="token number">2</span> tinychen.com. A: <span class="token builtin class-name">read</span> udp <span class="token number">127.0</span>.0.1:53697-<span class="token operator">></span><span class="token number">127.0</span>.0.1:35353: read: connection refused
Jan <span class="token number">14</span> <span class="token number">14</span>:29:32 coredns2 coredns: <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token number">10.31</span>.53.2:38422 - <span class="token number">21429</span> <span class="token string">"A IN tinychen.com. udp 38 false 4096"</span> - - <span class="token number">0</span> <span class="token number">0</span>.000386185s
Jan <span class="token number">14</span> <span class="token number">14</span>:29:32 coredns2 coredns: <span class="token punctuation">[</span>ERROR<span class="token punctuation">]</span> plugin/errors: <span class="token number">2</span> tinychen.com. A: <span class="token builtin class-name">read</span> udp <span class="token number">127.0</span>.0.1:34774-<span class="token operator">></span><span class="token number">127.0</span>.0.1:35353: read: connection refused
Jan <span class="token number">14</span> <span class="token number">14</span>:29:33 coredns2 coredns: <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token number">10.31</span>.53.2:44775 - <span class="token number">40543</span> <span class="token string">"A IN tinychen.com. udp 38 false 4096"</span> - - <span class="token number">0</span> <span class="token number">0</span>.000418209s
Jan <span class="token number">14</span> <span class="token number">14</span>:29:33 coredns2 coredns: <span class="token punctuation">[</span>ERROR<span class="token punctuation">]</span> plugin/errors: <span class="token number">2</span> tinychen.com. A: <span class="token builtin class-name">read</span> udp <span class="token number">127.0</span>.0.1:51575-<span class="token operator">></span><span class="token number">127.0</span>.0.1:35353: read: connection refused
Jan <span class="token number">14</span> <span class="token number">14</span>:29:33 coredns2 coredns: <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token number">10.31</span>.53.2:41858 - <span class="token number">30773</span> <span class="token string">"A IN tinychen.com. udp 38 false 4096"</span> - - <span class="token number">0</span> <span class="token number">0</span>.000285244s
Jan <span class="token number">14</span> <span class="token number">14</span>:29:33 coredns2 coredns: <span class="token punctuation">[</span>ERROR<span class="token punctuation">]</span> plugin/errors: <span class="token number">2</span> tinychen.com. A: <span class="token builtin class-name">read</span> udp <span class="token number">127.0</span>.0.1:54027-<span class="token operator">></span><span class="token number">127.0</span>.0.1:35353: read: connection refused
Jan <span class="token number">14</span> <span class="token number">14</span>:29:34 coredns2 coredns: <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token number">10.31</span>.53.2:56657 - <span class="token number">31457</span> <span class="token string">"A IN tinychen.com. udp 38 false 4096"</span> - - <span class="token number">0</span> <span class="token number">0</span>.000280881s
Jan <span class="token number">14</span> <span class="token number">14</span>:29:34 coredns2 coredns: <span class="token punctuation">[</span>ERROR<span class="token punctuation">]</span> plugin/errors: <span class="token number">2</span> tinychen.com. A: <span class="token builtin class-name">read</span> udp <span class="token number">127.0</span>.0.1:59189-<span class="token operator">></span><span class="token number">127.0</span>.0.1:35353: read: connection refused
Jan <span class="token number">14</span> <span class="token number">14</span>:29:34 coredns2 coredns: <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token number">10.31</span>.53.2:48445 - <span class="token number">29130</span> <span class="token string">"A IN tinychen.com. udp 38 false 4096"</span> - - <span class="token number">0</span> <span class="token number">0</span>.000399419s
Jan <span class="token number">14</span> <span class="token number">14</span>:29:34 coredns2 coredns: <span class="token punctuation">[</span>ERROR<span class="token punctuation">]</span> plugin/errors: <span class="token number">2</span> tinychen.com. A: <span class="token builtin class-name">read</span> udp <span class="token number">127.0</span>.0.1:35171-<span class="token operator">></span><span class="token number">127.0</span>.0.1:35353: read: connection refused
Jan <span class="token number">14</span> <span class="token number">14</span>:29:35 coredns2 coredns: <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token number">10.31</span>.53.2:42290 - <span class="token number">310</span> <span class="token string">"A IN tinychen.com. udp 38 false 4096"</span> - - <span class="token number">0</span> <span class="token number">0</span>.000359849s
Jan <span class="token number">14</span> <span class="token number">14</span>:29:35 coredns2 coredns: <span class="token punctuation">[</span>ERROR<span class="token punctuation">]</span> plugin/errors: <span class="token number">2</span> tinychen.com. A: <span class="token builtin class-name">read</span> udp <span class="token number">127.0</span>.0.1:40662-<span class="token operator">></span><span class="token number">127.0</span>.0.1:35353: read: connection refused
Jan <span class="token number">14</span> <span class="token number">14</span>:29:36 coredns2 coredns: <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token number">10.31</span>.53.2:33545 - <span class="token number">28529</span> <span class="token string">"A IN tinychen.com. udp 38 false 4096"</span> - - <span class="token number">0</span> <span class="token number">0</span>.000456204s
Jan <span class="token number">14</span> <span class="token number">14</span>:29:36 coredns2 coredns: <span class="token punctuation">[</span>ERROR<span class="token punctuation">]</span> plugin/errors: <span class="token number">2</span> tinychen.com. A: <span class="token builtin class-name">read</span> udp <span class="token number">127.0</span>.0.1:37439-<span class="token operator">></span><span class="token number">127.0</span>.0.1:35353: read: connection refused
Jan <span class="token number">14</span> <span class="token number">14</span>:29:36 coredns2 coredns: <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token number">10.31</span>.53.2:53167 - <span class="token number">18372</span> <span class="token string">"A IN tinychen.com. udp 38 false 4096"</span> - - <span class="token number">0</span> <span class="token number">0</span>.000426039s
Jan <span class="token number">14</span> <span class="token number">14</span>:29:36 coredns2 coredns: <span class="token punctuation">[</span>ERROR<span class="token punctuation">]</span> plugin/errors: <span class="token number">2</span> tinychen.com. A: <span class="token builtin class-name">read</span> udp <span class="token number">127.0</span>.0.1:45881-<span class="token operator">></span><span class="token number">127.0</span>.0.1:35353: read: connection refused
Jan <span class="token number">14</span> <span class="token number">14</span>:29:37 coredns2 coredns: <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token number">10.31</span>.53.2:44851 - <span class="token number">52388</span> <span class="token string">"A IN tinychen.com. udp 38 false 4096"</span> - - <span class="token number">0</span> <span class="token number">0</span>.000264627s
Jan <span class="token number">14</span> <span class="token number">14</span>:29:37 coredns2 coredns: <span class="token punctuation">[</span>ERROR<span class="token punctuation">]</span> plugin/errors: <span class="token number">2</span> tinychen.com. A: <span class="token builtin class-name">read</span> udp <span class="token number">127.0</span>.0.1:58678-<span class="token operator">></span><span class="token number">127.0</span>.0.1:35353: read: connection refused
Jan <span class="token number">14</span> <span class="token number">14</span>:29:37 coredns2 coredns: <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token number">10.31</span>.53.2:59500 - <span class="token number">19169</span> <span class="token string">"A IN tinychen.com. udp 38 false 4096"</span> - - <span class="token number">0</span> <span class="token number">0</span>.000385832s
Jan <span class="token number">14</span> <span class="token number">14</span>:29:37 coredns2 coredns: <span class="token punctuation">[</span>ERROR<span class="token punctuation">]</span> plugin/errors: <span class="token number">2</span> tinychen.com. A: <span class="token builtin class-name">read</span> udp <span class="token number">127.0</span>.0.1:36355-<span class="token operator">></span><span class="token number">127.0</span>.0.1:35353: read: connection refused
Jan <span class="token number">14</span> <span class="token number">14</span>:29:38 coredns2 coredns: <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token number">10.31</span>.53.2:48272 - <span class="token number">35987</span> <span class="token string">"A IN tinychen.com. udp 38 false 4096"</span> - - <span class="token number">0</span> <span class="token number">0</span>.000359493s
Jan <span class="token number">14</span> <span class="token number">14</span>:29:38 coredns2 coredns: <span class="token punctuation">[</span>ERROR<span class="token punctuation">]</span> plugin/errors: <span class="token number">2</span> tinychen.com. A: <span class="token builtin class-name">read</span> udp <span class="token number">127.0</span>.0.1:52055-<span class="token operator">></span><span class="token number">127.0</span>.0.1:35353: read: connection refused
Jan <span class="token number">14</span> <span class="token number">14</span>:29:39 coredns2 coredns: <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token number">10.31</span>.53.2:55974 - <span class="token number">48529</span> <span class="token string">"A IN tinychen.com. udp 38 false 4096"</span> - - <span class="token number">0</span> <span class="token number">0</span>.00035554s
Jan <span class="token number">14</span> <span class="token number">14</span>:29:39 coredns2 coredns: <span class="token punctuation">[</span>ERROR<span class="token punctuation">]</span> plugin/errors: <span class="token number">2</span> tinychen.com. A: <span class="token builtin class-name">read</span> udp <span class="token number">127.0</span>.0.1:51253-<span class="token operator">></span><span class="token number">127.0</span>.0.1:35353: read: connection refused
Jan <span class="token number">14</span> <span class="token number">14</span>:29:39 coredns2 coredns: <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token number">10.31</span>.53.2:40670 - <span class="token number">43374</span> <span class="token string">"A IN tinychen.com. udp 38 false 4096"</span> - - <span class="token number">0</span> <span class="token number">0</span>.00024835s
Jan <span class="token number">14</span> <span class="token number">14</span>:29:39 coredns2 coredns: <span class="token punctuation">[</span>ERROR<span class="token punctuation">]</span> plugin/errors: <span class="token number">2</span> tinychen.com. A: <span class="token builtin class-name">read</span> udp <span class="token number">127.0</span>.0.1:41919-<span class="token operator">></span><span class="token number">127.0</span>.0.1:35353: read: connection refused
Jan <span class="token number">14</span> <span class="token number">14</span>:29:40 coredns2 coredns: <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token number">10.31</span>.53.2:42067 - <span class="token number">780</span> <span class="token string">"A IN tinychen.com. udp 38 false 4096"</span> - - <span class="token number">0</span> <span class="token number">0</span>.000257447s
Jan <span class="token number">14</span> <span class="token number">14</span>:29:40 coredns2 coredns: <span class="token punctuation">[</span>ERROR<span class="token punctuation">]</span> plugin/errors: <span class="token number">2</span> tinychen.com. A: <span class="token builtin class-name">read</span> udp <span class="token number">127.0</span>.0.1:49359-<span class="token operator">></span><span class="token number">127.0</span>.0.1:35353: read: connection refused
Jan <span class="token number">14</span> <span class="token number">14</span>:29:40 coredns2 coredns: <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token number">10.31</span>.53.2:56758 - <span class="token number">62500</span> <span class="token string">"A IN tinychen.com. udp 38 false 4096"</span> - - <span class="token number">0</span> <span class="token number">0</span>.000338204s
Jan <span class="token number">14</span> <span class="token number">14</span>:29:40 coredns2 coredns: <span class="token punctuation">[</span>ERROR<span class="token punctuation">]</span> plugin/errors: <span class="token number">2</span> tinychen.com. A: <span class="token builtin class-name">read</span> udp <span class="token number">127.0</span>.0.1:44658-<span class="token operator">></span><span class="token number">127.0</span>.0.1:35353: read: connection refused
Jan <span class="token number">14</span> <span class="token number">14</span>:29:41 coredns2 coredns: <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token number">10.31</span>.53.2:36149 - <span class="token number">32955</span> <span class="token string">"A IN tinychen.com. udp 38 false 4096"</span> - - <span class="token number">0</span> <span class="token number">0</span>.000400937s
Jan <span class="token number">14</span> <span class="token number">14</span>:29:41 coredns2 coredns: <span class="token punctuation">[</span>ERROR<span class="token punctuation">]</span> plugin/errors: <span class="token number">2</span> tinychen.com. A: <span class="token builtin class-name">read</span> udp <span class="token number">127.0</span>.0.1:33750-<span class="token operator">></span><span class="token number">127.0</span>.0.1:35353: read: connection refused
Jan <span class="token number">14</span> <span class="token number">14</span>:29:41 coredns2 coredns: <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token number">10.31</span>.53.2:60504 - <span class="token number">49021</span> <span class="token string">"A IN tinychen.com. udp 38 false 4096"</span> - - <span class="token number">0</span> <span class="token number">0</span>.000272807s
Jan <span class="token number">14</span> <span class="token number">14</span>:29:41 coredns2 coredns: <span class="token punctuation">[</span>ERROR<span class="token punctuation">]</span> plugin/errors: <span class="token number">2</span> tinychen.com. A: <span class="token builtin class-name">read</span> udp <span class="token number">127.0</span>.0.1:41003-<span class="token operator">></span><span class="token number">127.0</span>.0.1:35353: read: connection refused

<span class="token comment"># 合并错误日志之后,合并输出30s内符合条件的错误日志总数，并且日志级别变为我们自定义的[WARNING]</span>
Jan <span class="token number">14</span> <span class="token number">14</span>:32:48 coredns2 coredns: <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token number">10.31</span>.53.2:60095 - <span class="token number">763</span> <span class="token string">"A IN tinychen.com. udp 38 false 4096"</span> - - <span class="token number">0</span> <span class="token number">0</span>.000389099s
Jan <span class="token number">14</span> <span class="token number">14</span>:33:10 coredns2 coredns: <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token number">10.31</span>.53.2:44256 - <span class="token number">21788</span> <span class="token string">"A IN tinychen.com. udp 38 false 4096"</span> - - <span class="token number">0</span> <span class="token number">0</span>.000556023s
Jan <span class="token number">14</span> <span class="token number">14</span>:33:11 coredns2 coredns: <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token number">10.31</span>.53.2:39654 - <span class="token number">18638</span> <span class="token string">"A IN tinychen.com. udp 38 false 4096"</span> - - <span class="token number">0</span> <span class="token number">0</span>.000394553s
Jan <span class="token number">14</span> <span class="token number">14</span>:33:11 coredns2 coredns: <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token number">10.31</span>.53.2:46340 - <span class="token number">23770</span> <span class="token string">"A IN tinychen.com. udp 38 false 4096"</span> - - <span class="token number">0</span> <span class="token number">0</span>.000405404s
Jan <span class="token number">14</span> <span class="token number">14</span>:33:12 coredns2 coredns: <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token number">10.31</span>.53.2:56168 - <span class="token number">59588</span> <span class="token string">"A IN tinychen.com. udp 38 false 4096"</span> - - <span class="token number">0</span> <span class="token number">0</span>.000351365s
Jan <span class="token number">14</span> <span class="token number">14</span>:33:13 coredns2 coredns: <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token number">10.31</span>.53.2:52337 - <span class="token number">28311</span> <span class="token string">"A IN tinychen.com. udp 38 false 4096"</span> - - <span class="token number">0</span> <span class="token number">0</span>.00033022s
Jan <span class="token number">14</span> <span class="token number">14</span>:33:14 coredns2 coredns: <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token number">10.31</span>.53.2:55564 - <span class="token number">52773</span> <span class="token string">"A IN tinychen.com. udp 38 false 4096"</span> - - <span class="token number">0</span> <span class="token number">0</span>.0002756s
Jan <span class="token number">14</span> <span class="token number">14</span>:33:14 coredns2 coredns: <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token number">10.31</span>.53.2:36233 - <span class="token number">21289</span> <span class="token string">"A IN tinychen.com. udp 38 false 4096"</span> - - <span class="token number">0</span> <span class="token number">0</span>.000307114s
Jan <span class="token number">14</span> <span class="token number">14</span>:33:15 coredns2 coredns: <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token number">10.31</span>.53.2:41822 - <span class="token number">41368</span> <span class="token string">"A IN tinychen.com. udp 38 false 4096"</span> - - <span class="token number">0</span> <span class="token number">0</span>.000379377s
Jan <span class="token number">14</span> <span class="token number">14</span>:33:18 coredns2 coredns: <span class="token punctuation">[</span>WARNING<span class="token punctuation">]</span> plugin/errors: <span class="token number">9</span> errors like <span class="token string">'.* connection refused$'</span> occurred <span class="token keyword">in</span> last 30s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>


              
            </div>
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/network/" class="category-chain-item">network</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/dns/">#dns</a>
      
        <a href="/tags/coredns/">#coredns</a>
      
        <a href="/tags/dnstap/">#dnstap</a>
      
    </div>
  
</div>


              

              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/20220220-dns-09-coredns-06-recursive-dns/" title="CoreDNS篇6-递归服务器">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">CoreDNS篇6-递归服务器</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/20211203-dpvs-fullnat-keepalived/" title="DPVS-FullNAT模式keepalived篇">
                        <span class="hidden-mobile">DPVS-FullNAT模式keepalived篇</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;Table of Contents</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  






    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">Keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <i class="iconfont icon-copyright"></i> <a href="https://tinychen.com/" target="_blank" rel="nofollow noopener"><span>2017~2022 By TinyChen </span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Hexo-Fluid</span></a> 
    </div>
  
  
  
    <!-- 备案信息 ICP for China -->
    <div class="beian">
  <span>
    <a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">
      粤ICP备18140640号
    </a>
  </span>
  
</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <!-- Baidu Analytics -->
    <script defer>
      if (!Fluid.ctx.dnt) {
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?7a96963a1145ac7fde1442d739a11ffd";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
      }
    </script>
  

  
    <!-- Google Analytics -->
    <script defer>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript('https://www.google-analytics.com/analytics.js', function() {
          window.ga = window.ga || function() { (ga.q = ga.q || []).push(arguments) };
          ga.l = +new Date;
          ga('create', 'UA-166769908-1', 'auto');
          ga('send', 'pageview');
        });
      }
    </script>
  

  

  

  

  

  




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.0/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script  src="https://lib.baomitu.com/prism/1.26.0/plugins/line-numbers/prism-line-numbers.min.js" ></script>

  <script>
  (function() {
    var enableLang = CONFIG.code_language.enable && CONFIG.code_language.default;
    var enableCopy = CONFIG.copy_btn;
    if (!enableLang && !enableCopy) {
      return;
    }

    function getBgClass(ele) {
      return Fluid.utils.getBackgroundLightness(ele) >= 0 ? 'code-widget-light' : 'code-widget-dark';
    }

    var copyTmpl = '';
    copyTmpl += '<div class="code-widget">';
    copyTmpl += 'LANG';
    copyTmpl += '</div>';
    jQuery('.markdown-body pre').each(function() {
      var $pre = jQuery(this);
      if ($pre.find('code.mermaid').length > 0) {
        return;
      }
      if ($pre.find('span.line').length > 0) {
        return;
      }

      var lang = '';

      if (enableLang) {
        lang = CONFIG.code_language.default;
        if ($pre[0].children.length > 0 && $pre[0].children[0].classList.length >= 2 && $pre.children().hasClass('hljs')) {
          lang = $pre[0].children[0].classList[1];
        } else if ($pre[0].getAttribute('data-language')) {
          lang = $pre[0].getAttribute('data-language');
        } else if ($pre.parent().hasClass('sourceCode') && $pre[0].children.length > 0 && $pre[0].children[0].classList.length >= 2) {
          lang = $pre[0].children[0].classList[1];
          $pre.parent().addClass('code-wrapper');
        } else if ($pre.parent().hasClass('markdown-body') && $pre[0].classList.length === 0) {
          $pre.wrap('<div class="code-wrapper"></div>');
        }
        lang = lang.toUpperCase().replace('NONE', CONFIG.code_language.default);
      }
      $pre.append(copyTmpl.replace('LANG', lang).replace('code-widget">',
        getBgClass($pre[0]) + (enableCopy ? ' code-widget copy-btn" data-clipboard-snippet><i class="iconfont icon-copy"></i>' : ' code-widget">')));

      if (enableCopy) {
        Fluid.utils.createScript('https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js', function() {
          var clipboard = new window.ClipboardJS('.copy-btn', {
            target: function(trigger) {
              var nodes = trigger.parentNode.childNodes;
              for (var i = 0; i < nodes.length; i++) {
                if (nodes[i].tagName === 'CODE') {
                  return nodes[i];
                }
              }
            }
          });
          clipboard.on('success', function(e) {
            e.clearSelection();
            e.trigger.innerHTML = e.trigger.innerHTML.replace('icon-copy', 'icon-success');
            setTimeout(function() {
              e.trigger.innerHTML = e.trigger.innerHTML.replace('icon-success', 'icon-copy');
            }, 2000);
          });
        });
      }
    });
  })();
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">Blog works best with JavaScript enabled</div>
  </noscript>
</body>
</html>
