

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="https://resource.tinychen.com/logos.png">
  <link rel="icon" href="https://resource.tinychen.com/logos.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="TinyChen">
  <meta name="keywords" content="">
  
    <meta name="description" content="本文主要在centos7系统上基于containerd和stable版本（1.11.4）的cilium组件部署v1.24.0版本的k8s原生集群，由于集群主要用于自己平时学习和测试使用，加上资源有限，暂不涉及高可用部署。 此外，由于cilium已经实现了对kube-proxy的一整套替代方案，这里部署k8s集群的时候会使用cilium的kubeproxy-free方案。 此前写的一些关于k8s基础">
<meta property="og:type" content="article">
<meta property="og:title" content="k8s系列05-使用containerd和cilium部署kubeproxy-free的k8s集群">
<meta property="og:url" content="https://tinychen.com/20220512-k8s-05-deploy-k8s-without-kubeproxy/index.html">
<meta property="og:site_name" content="TinyChen&#39;s Studio">
<meta property="og:description" content="本文主要在centos7系统上基于containerd和stable版本（1.11.4）的cilium组件部署v1.24.0版本的k8s原生集群，由于集群主要用于自己平时学习和测试使用，加上资源有限，暂不涉及高可用部署。 此外，由于cilium已经实现了对kube-proxy的一整套替代方案，这里部署k8s集群的时候会使用cilium的kubeproxy-free方案。 此前写的一些关于k8s基础">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://resource.tinychen.com/202205121511357.jpg">
<meta property="article:published_time" content="2022-05-12T07:00:00.000Z">
<meta property="article:modified_time" content="2022-05-12T07:00:00.000Z">
<meta property="article:author" content="TinyChen">
<meta property="article:tag" content="centos">
<meta property="article:tag" content="k8s">
<meta property="article:tag" content="docker">
<meta property="article:tag" content="cilium">
<meta property="article:tag" content="containerd">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://resource.tinychen.com/202205121511357.jpg">
  
  
  <title>k8s系列05-使用containerd和cilium部署kubeproxy-free的k8s集群 - TinyChen&#39;s Studio</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/prism/1.26.0/plugins/line-numbers/prism-line-numbers.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"tinychen.com","root":"/","version":"1.8.14","typing":{"enable":true,"typeSpeed":30,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"bash"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":1},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":"7a96963a1145ac7fde1442d739a11ffd","google":"UA-166769908-1","gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>

  
<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="TinyChen's Studio" type="application/atom+xml">
</head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>TinyChen</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archives
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                Categories
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                Tags
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                Links
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('https://resource.tinychen.com/202205121510902.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="k8s系列05-使用containerd和cilium部署kubeproxy-free的k8s集群"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-05-12 15:00" pubdate>
          May 12, 2022 pm
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          41k words
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          341 mins
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">k8s系列05-使用containerd和cilium部署kubeproxy-free的k8s集群</h1>
            
              <p class="note note-info">
                
                  
                    Last updated on May 12, 2022 pm
                  
                
              </p>
            
            <div class="markdown-body">
              
              <p>本文主要在centos7系统上基于<code>containerd</code>和<code>stable</code>版本（<code>1.11.4</code>）的<code>cilium</code>组件部署<code>v1.24.0</code>版本的k8s原生集群，由于集群主要用于自己平时学习和测试使用，加上资源有限，暂不涉及高可用部署。</p>
<p>此外，由于<code>cilium</code>已经实现了对<code>kube-proxy</code>的一整套替代方案，这里部署k8s集群的时候会使用cilium的<code>kubeproxy-free</code>方案。</p>
<p>此前写的一些关于k8s基础知识和集群搭建的一些<a href="https://tinychen.com/tags/k8s/">方案</a>，有需要的同学可以看一下。</p>
<span id="more"></span>

<h1 id="1、准备工作"><a href="#1、准备工作" class="headerlink" title="1、准备工作"></a>1、准备工作</h1><h2 id="1-1-集群信息"><a href="#1-1-集群信息" class="headerlink" title="1.1 集群信息"></a>1.1 集群信息</h2><p>机器均为8C8G的虚拟机，硬盘为100G。</p>
<table>
<thead>
<tr>
<th align="center">IP</th>
<th align="center">Hostname</th>
</tr>
</thead>
<tbody><tr>
<td align="center">10.31.18.1</td>
<td align="center">tiny-kubeproxy-free-master-18-1.k8s.tcinternal</td>
</tr>
<tr>
<td align="center">10.31.18.11</td>
<td align="center">tiny-kubeproxy-free-worker-18-11.k8s.tcinternal</td>
</tr>
<tr>
<td align="center">10.31.18.12</td>
<td align="center">tiny-kubeproxy-free-worker-18-12.k8s.tcinternal</td>
</tr>
<tr>
<td align="center">10.18.64.0/18</td>
<td align="center">podSubnet</td>
</tr>
<tr>
<td align="center">10.18.0.0/18</td>
<td align="center">serviceSubnet</td>
</tr>
</tbody></table>
<h2 id="1-2-检查mac和product-uuid"><a href="#1-2-检查mac和product-uuid" class="headerlink" title="1.2 检查mac和product_uuid"></a>1.2 检查mac和product_uuid</h2><p>同一个k8s集群内的所有节点需要确保<code>mac</code>地址和<code>product_uuid</code>均唯一，开始集群初始化之前需要检查相关信息</p>
<div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 检查mac地址</span>
<span class="token function">ip</span> <span class="token function">link</span> 
<span class="token function">ifconfig</span> -a

<span class="token comment"># 检查product_uuid</span>
<span class="token function">sudo</span> <span class="token function">cat</span> /sys/class/dmi/id/product_uuid<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>



<h2 id="1-3-配置ssh免密登录（可选）"><a href="#1-3-配置ssh免密登录（可选）" class="headerlink" title="1.3 配置ssh免密登录（可选）"></a>1.3 配置ssh免密登录（可选）</h2><p>如果k8s集群的节点有多个网卡，确保每个节点能通过正确的网卡互联访问</p>
<div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 在root用户下面生成一个公用的key，并配置可以使用该key免密登录</span>
<span class="token function">su</span> root
ssh-keygen
<span class="token builtin class-name">cd</span> /root/.ssh/
<span class="token function">cat</span> id_rsa.pub <span class="token operator">>></span> authorized_keys
<span class="token function">chmod</span> <span class="token number">600</span> authorized_keys


<span class="token function">cat</span> <span class="token operator">>></span> ~/.ssh/config <span class="token operator">&lt;&lt;</span><span class="token string">EOF
Host tiny-kubeproxy-free-master-18-1.k8s.tcinternal
    HostName 10.31.18.1
    User root
    Port 22
    IdentityFile ~/.ssh/id_rsa

Host tiny-kubeproxy-free-worker-18-11.k8s.tcinternal
    HostName 10.31.18.11
    User root
    Port 22
    IdentityFile ~/.ssh/id_rsa

Host tiny-kubeproxy-free-worker-18-12.k8s.tcinternal
    HostName 10.31.18.12
    User root
    Port 22
    IdentityFile ~/.ssh/id_rsa
EOF</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>



<h2 id="1-4-修改hosts文件"><a href="#1-4-修改hosts文件" class="headerlink" title="1.4 修改hosts文件"></a>1.4 修改hosts文件</h2><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">cat</span> <span class="token operator">>></span> /etc/hosts <span class="token operator">&lt;&lt;</span><span class="token string">EOF
10.31.18.1 tiny-kubeproxy-free-master-18-1.k8s.tcinternal
10.31.18.11 tiny-kubeproxy-free-worker-18-11.k8s.tcinternal
10.31.18.12 tiny-kubeproxy-free-worker-18-12.k8s.tcinternal
EOF</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>



<h2 id="1-5-关闭swap内存"><a href="#1-5-关闭swap内存" class="headerlink" title="1.5 关闭swap内存"></a>1.5 关闭swap内存</h2><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 使用命令直接关闭swap内存</span>
swapoff -a
<span class="token comment"># 修改fstab文件禁止开机自动挂载swap分区</span>
<span class="token function">sed</span> -i <span class="token string">'/swap / s/^\(.*\)$/#<span class="token entity" title="\1">\1</span>/g'</span> /etc/fstab<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></div>



<h2 id="1-6-配置时间同步"><a href="#1-6-配置时间同步" class="headerlink" title="1.6 配置时间同步"></a>1.6 配置时间同步</h2><p>这里可以根据自己的习惯选择ntp或者是chrony同步均可，同步的时间源服务器可以选择阿里云的<code>ntp1.aliyun.com</code>或者是国家时间中心的<code>ntp.ntsc.ac.cn</code>。</p>
<h3 id="使用ntp同步"><a href="#使用ntp同步" class="headerlink" title="使用ntp同步"></a>使用ntp同步</h3><div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none"># 使用yum安装ntpdate工具
yum install ntpdate -y

# 使用国家时间中心的源同步时间
ntpdate ntp.ntsc.ac.cn

# 最后查看一下时间
hwclock<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>

<h3 id="使用chrony同步"><a href="#使用chrony同步" class="headerlink" title="使用chrony同步"></a>使用chrony同步</h3><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 使用yum安装chrony</span>
yum <span class="token function">install</span> chrony -y

<span class="token comment"># 设置开机启动并开启chony并查看运行状态</span>
systemctl <span class="token builtin class-name">enable</span> chronyd.service
systemctl start chronyd.service
systemctl status chronyd.service

<span class="token comment"># 当然也可以自定义时间服务器</span>
<span class="token function">vim</span> /etc/chrony.conf

<span class="token comment"># 修改前</span>
$ <span class="token function">grep</span> server /etc/chrony.conf
<span class="token comment"># Use public servers from the pool.ntp.org project.</span>
server <span class="token number">0</span>.centos.pool.ntp.org iburst
server <span class="token number">1</span>.centos.pool.ntp.org iburst
server <span class="token number">2</span>.centos.pool.ntp.org iburst
server <span class="token number">3</span>.centos.pool.ntp.org iburst

<span class="token comment"># 修改后</span>
$ <span class="token function">grep</span> server /etc/chrony.conf
<span class="token comment"># Use public servers from the pool.ntp.org project.</span>
server ntp.ntsc.ac.cn iburst

<span class="token comment"># 重启服务使配置文件生效</span>
systemctl restart chronyd.service

<span class="token comment"># 查看chrony的ntp服务器状态</span>
chronyc sourcestats -v
chronyc sources -v
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>



<h2 id="1-7-关闭selinux"><a href="#1-7-关闭selinux" class="headerlink" title="1.7 关闭selinux"></a>1.7 关闭selinux</h2><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 使用命令直接关闭</span>
setenforce <span class="token number">0</span>

<span class="token comment"># 也可以直接修改/etc/selinux/config文件</span>
<span class="token function">sed</span> -i <span class="token string">'s/^SELINUX=enforcing$/SELINUX=disabled/'</span> /etc/selinux/config<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>



<h2 id="1-8-配置防火墙"><a href="#1-8-配置防火墙" class="headerlink" title="1.8 配置防火墙"></a>1.8 配置防火墙</h2><p>k8s集群之间通信和服务暴露需要使用较多端口，为了方便，直接禁用防火墙</p>
<div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># centos7使用systemctl禁用默认的firewalld服务</span>
systemctl disable firewalld.service<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div>



<h2 id="1-9-配置netfilter参数"><a href="#1-9-配置netfilter参数" class="headerlink" title="1.9 配置netfilter参数"></a>1.9 配置netfilter参数</h2><p>这里主要是需要配置内核加载<code>br_netfilter</code>和<code>iptables</code>放行<code>ipv6</code>和<code>ipv4</code>的流量，确保集群内的容器能够正常通信。</p>
<div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">cat &lt;&lt;EOF | sudo tee &#x2F;etc&#x2F;modules-load.d&#x2F;k8s.conf
br_netfilter
EOF

cat &lt;&lt;EOF | sudo tee &#x2F;etc&#x2F;sysctl.d&#x2F;k8s.conf
net.bridge.bridge-nf-call-ip6tables &#x3D; 1
net.bridge.bridge-nf-call-iptables &#x3D; 1
EOF
sudo sysctl --system<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>



<h2 id="1-10-关闭IPV6（不建议）"><a href="#1-10-关闭IPV6（不建议）" class="headerlink" title="1.10 关闭IPV6（不建议）"></a>1.10 关闭IPV6（不建议）</h2><p>和之前部署其他的CNI不一样，cilium很多服务监听默认情况下都是双栈的（使用cilium-cli操作的时候），因此建议开启系统的IPV6网络支持（即使没有可用的IPV6路由也可以）</p>
<p>当然没有ipv6网络也是可以的，只是在使用cilium-cli的一些开启port-forward命令时会报错而已。</p>
<div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 直接在内核中添加ipv6禁用参数</span>
grubby --update-kernel<span class="token operator">=</span>ALL --args<span class="token operator">=</span>ipv6.disable<span class="token operator">=</span><span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div>



<h2 id="1-11-配置IPVS（可以不用）"><a href="#1-11-配置IPVS（可以不用）" class="headerlink" title="1.11 配置IPVS（可以不用）"></a>1.11 配置IPVS（可以不用）</h2><p>IPVS是专门设计用来应对负载均衡场景的组件，<a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/blob/master/pkg/proxy/ipvs/README.md#run-kube-proxy-in-ipvs-mode">kube-proxy 中的 IPVS 实现</a>通过减少对 iptables 的使用来增加可扩展性。在 iptables 输入链中不使用 PREROUTING，而是创建一个假的接口，叫做 kube-ipvs0，当k8s集群中的负载均衡配置变多的时候，IPVS能实现比iptables更高效的转发性能。</p>
<p><strong>如果我们使用的是cilium来完全替代kube-proxy，那么实际上就用不到ipvs和iptables，因此这一步理论上是可以跳过的。</strong></p>
<blockquote>
<p>因为cilium需要升级系统内核，因此这里的内核版本高于4.19</p>
<p>注意在4.19之后的内核版本中使用<code>nf_conntrack</code>模块来替换了原有的<code>nf_conntrack_ipv4</code>模块</p>
<p>(<strong>Notes</strong>: use <code>nf_conntrack</code> instead of <code>nf_conntrack_ipv4</code> for Linux kernel 4.19 and later)</p>
</blockquote>
<div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 在使用ipvs模式之前确保安装了ipset和ipvsadm</span>
<span class="token function">sudo</span> yum <span class="token function">install</span> ipset ipvsadm -y

<span class="token comment"># 手动加载ipvs相关模块</span>
modprobe -- ip_vs
modprobe -- ip_vs_rr
modprobe -- ip_vs_wrr
modprobe -- ip_vs_sh
modprobe -- nf_conntrack

<span class="token comment"># 配置开机自动加载ipvs相关模块</span>
<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/modules-load.d/ipvs.conf</span>
ip_vs
ip_vs_rr
ip_vs_wrr
ip_vs_sh
nf_conntrack
EOF</span>

<span class="token function">sudo</span> sysctl --system
<span class="token comment"># 最好重启一遍系统确定是否生效</span>

$ lsmod <span class="token operator">|</span> <span class="token function">grep</span> -e ip_vs -e nf_conntrack
nf_conntrack_netlink    <span class="token number">49152</span>  <span class="token number">0</span>
nfnetlink              <span class="token number">20480</span>  <span class="token number">2</span> nf_conntrack_netlink
ip_vs_sh               <span class="token number">16384</span>  <span class="token number">0</span>
ip_vs_wrr              <span class="token number">16384</span>  <span class="token number">0</span>
ip_vs_rr               <span class="token number">16384</span>  <span class="token number">0</span>
ip_vs                 <span class="token number">159744</span>  <span class="token number">6</span> ip_vs_rr,ip_vs_sh,ip_vs_wrr
nf_conntrack          <span class="token number">159744</span>  <span class="token number">5</span> xt_conntrack,nf_nat,nf_conntrack_netlink,xt_MASQUERADE,ip_vs
nf_defrag_ipv4         <span class="token number">16384</span>  <span class="token number">1</span> nf_conntrack
nf_defrag_ipv6         <span class="token number">24576</span>  <span class="token number">2</span> nf_conntrack,ip_vs
libcrc32c              <span class="token number">16384</span>  <span class="token number">4</span> nf_conntrack,nf_nat,xfs,ip_vs
$ <span class="token function">cut</span> -f1 -d <span class="token string">" "</span>  /proc/modules <span class="token operator">|</span> <span class="token function">grep</span> -e ip_vs -e nf_conntrack
nf_conntrack_netlink
ip_vs_sh
ip_vs_wrr
ip_vs_rr
ip_vs
nf_conntrack<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>

<h2 id="1-12-配置Linux内核（cilium必选）"><a href="#1-12-配置Linux内核（cilium必选）" class="headerlink" title="1.12 配置Linux内核（cilium必选）"></a>1.12 配置Linux内核（cilium必选）</h2><p>cilium和其他的cni组件最大的不同在于其底层使用了ebpf技术，而该技术对于Linux的系统内核版本有较高的要求，完成的要求可以查看官网的<a target="_blank" rel="noopener" href="https://docs.cilium.io/en/latest/operations/system_requirements/">详细链接</a>，这里我们着重看内核版本、内核参数这两个部分。</p>
<h3 id="Linux内核版本"><a href="#Linux内核版本" class="headerlink" title="Linux内核版本"></a>Linux内核版本</h3><p>默认情况下我们可以参考cilium官方给出的一个系统要求总结。因为我们是在k8s集群中部署（使用容器），因此只需要关注Linux内核版本和etcd版本即可。根据前面部署的经验我们可以知道1.23.6版本的k8s默认使用的etcd版本是<code>3.5.+</code>，因此重点就来到了Linux内核版本这里。</p>
<table>
<thead>
<tr>
<th>Requirement</th>
<th>Minimum Version</th>
<th>In cilium container</th>
</tr>
</thead>
<tbody><tr>
<td><a target="_blank" rel="noopener" href="https://docs.cilium.io/en/latest/operations/system_requirements/#linux-kernel">Linux kernel</a></td>
<td>&gt;= 4.9.17</td>
<td>no</td>
</tr>
<tr>
<td>Key-Value store (etcd)</td>
<td>&gt;= 3.1.0</td>
<td>no</td>
</tr>
<tr>
<td>clang+LLVM</td>
<td>&gt;= 10.0</td>
<td>yes</td>
</tr>
<tr>
<td>iproute2</td>
<td>&gt;= 5.9.0</td>
<td>yes</td>
</tr>
</tbody></table>
<blockquote>
<p>This requirement is only needed if you run <code>cilium-agent</code> natively. If you are using the Cilium container image <code>cilium/cilium</code>, clang+LLVM is included in the container image.</p>
<p>iproute2 is only needed if you run <code>cilium-agent</code> directly on the host machine. iproute2 is included in the <code>cilium/cilium</code> container image.</p>
</blockquote>
<p>毫无疑问CentOS7内置的默认内核版本3.10.x版本的内核是无法满足需求的，但是在升级内核之前，我们再看看其他的一些要求。</p>
<p>cilium官方还给出了<a target="_blank" rel="noopener" href="https://docs.cilium.io/en/latest/operations/system_requirements/#required-kernel-versions-for-advanced-features">一份列表</a>描述了各项高级功能对内核版本的要求：</p>
<table>
<thead>
<tr>
<th>Cilium Feature</th>
<th>Minimum Kernel Version</th>
</tr>
</thead>
<tbody><tr>
<td><a target="_blank" rel="noopener" href="https://docs.cilium.io/en/latest/concepts/networking/fragmentation/#concepts-fragmentation">IPv4 fragment handling</a></td>
<td>&gt;= 4.10</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.cilium.io/en/latest/operations/upgrade/#cidr-limitations">Restrictions on unique prefix lengths for CIDR policy rules</a></td>
<td>&gt;= 4.11</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.cilium.io/en/latest/gettingstarted/encryption-ipsec/#encryption-ipsec">IPsec Transparent Encryption</a> in tunneling mode</td>
<td>&gt;= 4.19</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.cilium.io/en/latest/gettingstarted/encryption-wireguard/#encryption-wg">WireGuard Transparent Encryption</a></td>
<td>&gt;= 5.6</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.cilium.io/en/latest/gettingstarted/host-services/#host-services">Host-Reachable Services</a></td>
<td>&gt;= 4.19.57, &gt;= 5.1.16, &gt;= 5.2</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.cilium.io/en/latest/gettingstarted/kubeproxy-free/#kubeproxy-free">Kubernetes Without kube-proxy</a></td>
<td>&gt;= 4.19.57, &gt;= 5.1.16, &gt;= 5.2</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.cilium.io/en/latest/gettingstarted/bandwidth-manager/#bandwidth-manager">Bandwidth Manager</a></td>
<td>&gt;= 5.1</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.cilium.io/en/latest/gettingstarted/local-redirect-policy/#local-redirect-policy">Local Redirect Policy (beta)</a></td>
<td>&gt;= 4.19.57, &gt;= 5.1.16, &gt;= 5.2</td>
</tr>
<tr>
<td>Full support for <a target="_blank" rel="noopener" href="https://docs.cilium.io/en/latest/gettingstarted/kubeproxy-free/#session-affinity">Session Affinity</a></td>
<td>&gt;= 5.7</td>
</tr>
<tr>
<td>BPF-based proxy redirection</td>
<td>&gt;= 5.7</td>
</tr>
<tr>
<td>BPF-based host routing</td>
<td>&gt;= 5.10</td>
</tr>
<tr>
<td>Socket-level LB bypass in pod netns</td>
<td>&gt;= 5.7</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.cilium.io/en/latest/gettingstarted/egress-gateway/#egress-gateway">Egress Gateway (beta)</a></td>
<td>&gt;= 5.2</td>
</tr>
<tr>
<td>VXLAN Tunnel Endpoint (VTEP) Integration</td>
<td>&gt;= 5.2</td>
</tr>
</tbody></table>
<p>可以看到如果需要满足上面所有需求的话，需要内核版本高于5.10，本着学习测试研究作死的精神，反正都升级了，干脆就升级到新一些的版本吧。这里我们可以直接<a href="https://tinychen.com/20190612-centos-update-kernel/">使用elrepo源来升级内核</a>到较新的内核版本。</p>
<div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查看elrepo源中支持的内核版本</span>
$ yum --disablerepo<span class="token operator">=</span><span class="token string">"*"</span> --enablerepo<span class="token operator">=</span><span class="token string">"elrepo-kernel"</span> list available
Loaded plugins: fastestmirror
Loading mirror speeds from cached hostfile
Available Packages
elrepo-release.noarch                                                                   <span class="token number">7.0</span>-5.el7.elrepo                                                           elrepo-kernel
kernel-lt.x86_64                                                                        <span class="token number">5.4</span>.192-1.el7.elrepo                                                       elrepo-kernel
kernel-lt-devel.x86_64                                                                  <span class="token number">5.4</span>.192-1.el7.elrepo                                                       elrepo-kernel
kernel-lt-doc.noarch                                                                    <span class="token number">5.4</span>.192-1.el7.elrepo                                                       elrepo-kernel
kernel-lt-headers.x86_64                                                                <span class="token number">5.4</span>.192-1.el7.elrepo                                                       elrepo-kernel
kernel-lt-tools.x86_64                                                                  <span class="token number">5.4</span>.192-1.el7.elrepo                                                       elrepo-kernel
kernel-lt-tools-libs.x86_64                                                             <span class="token number">5.4</span>.192-1.el7.elrepo                                                       elrepo-kernel
kernel-lt-tools-libs-devel.x86_64                                                       <span class="token number">5.4</span>.192-1.el7.elrepo                                                       elrepo-kernel
kernel-ml.x86_64                                                                        <span class="token number">5.17</span>.6-1.el7.elrepo                                                        elrepo-kernel
kernel-ml-devel.x86_64                                                                  <span class="token number">5.17</span>.6-1.el7.elrepo                                                        elrepo-kernel
kernel-ml-doc.noarch                                                                    <span class="token number">5.17</span>.6-1.el7.elrepo                                                        elrepo-kernel
kernel-ml-headers.x86_64                                                                <span class="token number">5.17</span>.6-1.el7.elrepo                                                        elrepo-kernel
kernel-ml-tools.x86_64                                                                  <span class="token number">5.17</span>.6-1.el7.elrepo                                                        elrepo-kernel
kernel-ml-tools-libs.x86_64                                                             <span class="token number">5.17</span>.6-1.el7.elrepo                                                        elrepo-kernel
kernel-ml-tools-libs-devel.x86_64                                                       <span class="token number">5.17</span>.6-1.el7.elrepo                                                        elrepo-kernel
perf.x86_64                                                                             <span class="token number">5.17</span>.6-1.el7.elrepo                                                        elrepo-kernel
python-perf.x86_64                                                                      <span class="token number">5.17</span>.6-1.el7.elrepo                                                        elrepo-kernel

<span class="token comment"># 看起来ml版本的内核比较满足我们的需求,直接使用yum进行安装</span>
<span class="token function">sudo</span> yum --enablerepo<span class="token operator">=</span>elrepo-kernel <span class="token function">install</span> kernel-ml -y
<span class="token comment"># 使用grubby工具查看系统中已经安装的内核版本信息</span>
<span class="token function">sudo</span> grubby --info<span class="token operator">=</span>ALL
<span class="token comment"># 设置新安装的5.17.6版本内核为默认内核版本，此处的index=0要和上面查看的内核版本信息一致</span>
<span class="token function">sudo</span> grubby --set-default-index<span class="token operator">=</span><span class="token number">0</span>
<span class="token comment"># 查看默认内核是否修改成功</span>
<span class="token function">sudo</span> grubby --default-kernel
<span class="token comment"># 重启系统切换到新内核</span>
init <span class="token number">6</span>
<span class="token comment"># 重启后检查内核版本是否为新的5.17.6</span>
<span class="token function">uname</span> -a<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>

<h3 id="Linux内核参数"><a href="#Linux内核参数" class="headerlink" title="Linux内核参数"></a>Linux内核参数</h3><p>首先我们查看自己当前内核版本的参数，基本上可以分为<code>y</code>、<code>n</code>、<code>m</code>三个选项</p>
<ul>
<li>y：yes，Build directly into the kernel. 表示该功能被编译进内核中，默认启用</li>
<li>n：no，Leave entirely out of the kernel. 表示该功能未被编译进内核中，不启用</li>
<li>m：module，Build as a module, to be loaded if needed. 表示该功能被编译为模块，按需启用</li>
</ul>
<div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none"># 查看当前使用的内核版本的编译参数
cat &#x2F;boot&#x2F;config-$(uname -r)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div>

<p>cilium官方对各项功能所需要开启的<a target="_blank" rel="noopener" href="https://docs.cilium.io/en/latest/operations/system_requirements/#linux-kernel">内核参数列举</a>如下：</p>
<blockquote>
<p>In order for the eBPF feature to be enabled properly, the following kernel configuration options must be enabled. This is typically the case with distribution kernels. When an option can be built as a module or statically linked, either choice is valid.</p>
<p>为了正确启用 eBPF 功能，必须启用以下内核配置选项。这通常因内核版本情况而异。任何一个选项都可以构建为模块或静态链接，两个选择都是有效的。</p>
</blockquote>
<p>我们暂时只看最基本的<code>Base Requirements</code></p>
<div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">CONFIG_BPF&#x3D;y
CONFIG_BPF_SYSCALL&#x3D;y
CONFIG_NET_CLS_BPF&#x3D;y
CONFIG_BPF_JIT&#x3D;y
CONFIG_NET_CLS_ACT&#x3D;y
CONFIG_NET_SCH_INGRESS&#x3D;y
CONFIG_CRYPTO_SHA1&#x3D;y
CONFIG_CRYPTO_USER_API_HASH&#x3D;y
CONFIG_CGROUPS&#x3D;y
CONFIG_CGROUP_BPF&#x3D;y<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>

<p>对比我们使用的<code>5.17.6-1.el7.elrepo.x86_64</code>内核可以发现有两个模块是为m</p>
<div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">egrep</span> <span class="token string">"^CONFIG_BPF=|^CONFIG_BPF_SYSCALL=|^CONFIG_NET_CLS_BPF=|^CONFIG_BPF_JIT=|^CONFIG_NET_CLS_ACT=|^CONFIG_NET_SCH_INGRESS=|^CONFIG_CRYPTO_SHA1=|^CONFIG_CRYPTO_USER_API_HASH=|^CONFIG_CGROUPS=|^CONFIG_CGROUP_BPF="</span> /boot/config-5.17.6-1.el7.elrepo.x86_64
<span class="token assign-left variable">CONFIG_BPF</span><span class="token operator">=</span>y
<span class="token assign-left variable">CONFIG_BPF_SYSCALL</span><span class="token operator">=</span>y
<span class="token assign-left variable">CONFIG_BPF_JIT</span><span class="token operator">=</span>y
<span class="token assign-left variable">CONFIG_CGROUPS</span><span class="token operator">=</span>y
<span class="token assign-left variable">CONFIG_CGROUP_BPF</span><span class="token operator">=</span>y
<span class="token assign-left variable">CONFIG_NET_SCH_INGRESS</span><span class="token operator">=</span>m
<span class="token assign-left variable">CONFIG_NET_CLS_BPF</span><span class="token operator">=</span>m
<span class="token assign-left variable">CONFIG_NET_CLS_ACT</span><span class="token operator">=</span>y
<span class="token assign-left variable">CONFIG_CRYPTO_SHA1</span><span class="token operator">=</span>y
<span class="token assign-left variable">CONFIG_CRYPTO_USER_API_HASH</span><span class="token operator">=</span>y<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>

<p>缺少的这两个模块我们可以在<code>/usr/lib/modules/$(uname -r)</code>目录下面找到它们：</p>
<div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ realpath ./kernel/net/sched/sch_ingress.ko
/usr/lib/modules/5.17.6-1.el7.elrepo.x86_64/kernel/net/sched/sch_ingress.ko
$ realpath ./kernel/net/sched/cls_bpf.ko
/usr/lib/modules/5.17.6-1.el7.elrepo.x86_64/kernel/net/sched/cls_bpf.ko<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></div>

<p>确认相关内核模块存在我们直接加载内核即可：</p>
<div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 直接使用modprobe命令加载</span>
$ modprobe cls_bpf
$ modprobe sch_ingress
$ lsmod <span class="token operator">|</span> <span class="token function">egrep</span> <span class="token string">"cls_bpf|sch_ingress"</span>
sch_ingress            <span class="token number">16384</span>  <span class="token number">0</span>
cls_bpf                <span class="token number">24576</span>  <span class="token number">0</span>

<span class="token comment"># 配置开机自动加载cilium所需相关模块</span>
<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/modules-load.d/cilium-base-requirements.conf</span>
cls_bpf
sch_ingress
EOF</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>

<p>其他cilium高级功能所需要的内核功能也类似，这里不做赘述。</p>
<h1 id="2、安装container-runtime"><a href="#2、安装container-runtime" class="headerlink" title="2、安装container runtime"></a>2、安装container runtime</h1><h2 id="2-1-安装containerd"><a href="#2-1-安装containerd" class="headerlink" title="2.1 安装containerd"></a>2.1 安装containerd</h2><p>详细的官方文档可以参考<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/setup/production-environment/container-runtimes/">这里</a>，由于在刚发布的1.24版本中移除了<code>docker-shim</code>，因此安装的<code>版本≥1.24</code>的时候需要注意<code>容器运行时</code>的选择。这里我们安装的版本为最新的1.24，因此我们不能继续使用docker，这里我们将其换为<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/setup/production-environment/container-runtimes/#containerd">containerd</a></p>
<h3 id="修改Linux内核参数"><a href="#修改Linux内核参数" class="headerlink" title="修改Linux内核参数"></a>修改Linux内核参数</h3><div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 首先生成配置文件确保配置持久化</span>
<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/modules-load.d/containerd.conf</span>
overlay
br_netfilter
EOF</span>

<span class="token function">sudo</span> modprobe overlay
<span class="token function">sudo</span> modprobe br_netfilter

<span class="token comment"># Setup required sysctl params, these persist across reboots.</span>
<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/sysctl.d/99-kubernetes-cri.conf</span>
net.bridge.bridge-nf-call-iptables  = 1
net.ipv4.ip_forward                 = 1
net.bridge.bridge-nf-call-ip6tables = 1
EOF</span>

<span class="token comment"># Apply sysctl params without reboot</span>
<span class="token function">sudo</span> sysctl --system<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>

<h3 id="安装containerd"><a href="#安装containerd" class="headerlink" title="安装containerd"></a>安装containerd</h3><p>centos7比较方便的部署方式是利用已有的yum源进行安装，这里我们可以使用docker官方的yum源来安装<code>containerd</code></p>
<div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 导入docker官方的yum源</span>
<span class="token function">sudo</span> yum <span class="token function">install</span> -y yum-utils device-mapper-persistent-data lvm2

<span class="token function">sudo</span> yum-config-manager --add-repo  https://download.docker.com/linux/centos/docker-ce.repo

<span class="token comment"># 查看yum源中存在的各个版本的containerd.io</span>
yum list containerd.io --showduplicates <span class="token operator">|</span> <span class="token function">sort</span> -r

<span class="token comment"># 直接安装最新版本的containerd.io</span>
yum <span class="token function">install</span> containerd.io -y

<span class="token comment"># 启动containerd</span>
<span class="token function">sudo</span> systemctl start containerd

<span class="token comment"># 最后我们还要设置一下开机启动</span>
<span class="token function">sudo</span> systemctl <span class="token builtin class-name">enable</span> --now containerd
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>

<h3 id="关于CRI"><a href="#关于CRI" class="headerlink" title="关于CRI"></a>关于CRI</h3><p>官方表示，对于k8s来说，不需要安装<code>cri-containerd</code>，并且该功能会在后面的2.0版本中废弃。</p>
<blockquote>
<p><strong>FAQ</strong>: For Kubernetes, do I need to download <code>cri-containerd-(cni-)&lt;VERSION&gt;-&lt;OS-&lt;ARCH&gt;.tar.gz</code> too?</p>
<p><strong>Answer</strong>: No.</p>
<p>As the Kubernetes CRI feature has been already included in <code>containerd-&lt;VERSION&gt;-&lt;OS&gt;-&lt;ARCH&gt;.tar.gz</code>, you do not need to download the <code>cri-containerd-....</code> archives to use CRI.</p>
<p>The <code>cri-containerd-...</code> archives are <a target="_blank" rel="noopener" href="https://github.com/containerd/containerd/blob/main/RELEASES.md#deprecated-features">deprecated</a>, do not work on old Linux distributions, and will be removed in containerd 2.0.</p>
</blockquote>
<h3 id="安装cni-plugins"><a href="#安装cni-plugins" class="headerlink" title="安装cni-plugins"></a>安装cni-plugins</h3><p>使用yum源安装的方式会把runc安装好，但是并不会安装cni-plugins，因此这部分还是需要我们自行安装。</p>
<blockquote>
<p>The <code>containerd.io</code> package contains runc too, but does not contain CNI plugins.</p>
</blockquote>
<p>我们直接在<a target="_blank" rel="noopener" href="https://github.com/containernetworking/plugins/releases">github上面</a>找到系统对应的架构版本，这里为amd64，然后解压即可。</p>
<div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># Download the cni-plugins-&lt;OS>-&lt;ARCH>-&lt;VERSION>.tgz archive from https://github.com/containernetworking/plugins/releases , verify its sha256sum, and extract it under /opt/cni/bin:</span>

<span class="token comment"># 下载源文件和sha512文件并校验</span>
$ <span class="token function">wget</span> https://github.com/containernetworking/plugins/releases/download/v1.1.1/cni-plugins-linux-amd64-v1.1.1.tgz
$ <span class="token function">wget</span> https://github.com/containernetworking/plugins/releases/download/v1.1.1/cni-plugins-linux-amd64-v1.1.1.tgz.sha512
$ sha512sum -c cni-plugins-linux-amd64-v1.1.1.tgz.sha512

<span class="token comment"># 创建目录并解压</span>
$ <span class="token function">mkdir</span> -p /opt/cni/bin
$ <span class="token function">tar</span> Cxzvf /opt/cni/bin cni-plugins-linux-amd64-v1.1.1.tgz<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>



<h2 id="2-2-配置cgroup-drivers"><a href="#2-2-配置cgroup-drivers" class="headerlink" title="2.2 配置cgroup drivers"></a>2.2 配置cgroup drivers</h2><p>CentOS7使用的是<code>systemd</code>来初始化系统并管理进程，初始化进程会生成并使用一个 root 控制组 (<code>cgroup</code>), 并充当 <code>cgroup</code> 管理器。 <code>Systemd</code> 与 <code>cgroup</code> 集成紧密，并将为每个 <code>systemd</code> 单元分配一个 <code>cgroup</code>。 我们也可以配置<code>容器运行时</code>和 <code>kubelet</code> 使用 <code>cgroupfs</code>。 连同 <code>systemd</code> 一起使用 <code>cgroupfs</code> 意味着将有两个不同的 <code>cgroup 管理器</code>。而当一个系统中同时存在cgroupfs和systemd两者时，容易变得不稳定，因此最好更改设置，令容器运行时和 kubelet 使用 <code>systemd</code> 作为 <code>cgroup</code> 驱动，以此使系统更为稳定。 对于<code>containerd</code>, 需要设置配置文件<code>/etc/containerd/config.toml</code>中的 <code>SystemdCgroup</code> 参数。</p>
<blockquote>
<p>参考k8s官方的说明文档：</p>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/setup/production-environment/container-runtimes/#containerd-systemd">https://kubernetes.io/docs/setup/production-environment/container-runtimes/#containerd-systemd</a></p>
</blockquote>
<div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>plugins.<span class="token string">"io.containerd.grpc.v1.cri"</span>.containerd.runtimes.runc<span class="token punctuation">]</span>
  <span class="token punctuation">..</span>.
  <span class="token punctuation">[</span>plugins.<span class="token string">"io.containerd.grpc.v1.cri"</span>.containerd.runtimes.runc.options<span class="token punctuation">]</span>
    SystemdCgroup <span class="token operator">=</span> <span class="token boolean">true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></div>

<p>接下来我们开始配置containerd的cgroup driver</p>
<div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查看默认的配置文件，我们可以看到是没有启用systemd</span>
$ containerd config default <span class="token operator">|</span> <span class="token function">grep</span> SystemdCgroup
            SystemdCgroup <span class="token operator">=</span> <span class="token boolean">false</span>
            
<span class="token comment"># 使用yum安装的containerd的配置文件非常简单</span>
$ <span class="token function">cat</span> /etc/containerd/config.toml <span class="token operator">|</span> <span class="token function">egrep</span> -v <span class="token string">"^#|^$"</span>
disabled_plugins <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"cri"</span><span class="token punctuation">]</span>

<span class="token comment"># 导入一个完整版的默认配置文件模板为config.toml</span>
$ <span class="token function">mv</span> /etc/containerd/config.toml /etc/containerd/config.toml.origin
$ containerd config default <span class="token operator">></span> /etc/containerd/config.toml
<span class="token comment"># 修改SystemdCgroup参数并重启</span>
$ <span class="token function">sed</span> -i <span class="token string">'s/SystemdCgroup = false/SystemdCgroup = true/g'</span> /etc/containerd/config.toml
$ systemctl restart containerd

<span class="token comment"># 查看containerd状态的时候我们可以看到cni相关的报错</span>
<span class="token comment"># 这是因为我们先安装了cni-plugins但是还没有安装k8s的cni插件</span>
<span class="token comment"># 属于正常情况</span>
$ systemctl status containerd -l
May <span class="token number">12</span> 09:57:31 tiny-kubeproxy-free-master-18-1.k8s.tcinternal containerd<span class="token punctuation">[</span><span class="token number">5758</span><span class="token punctuation">]</span>: <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token string">"2022-05-12T09:57:31.100285056+08:00"</span> <span class="token assign-left variable">level</span><span class="token operator">=</span>error <span class="token assign-left variable">msg</span><span class="token operator">=</span><span class="token string">"failed to load cni during init, please check CRI plugin status before setting up network for pods"</span> <span class="token assign-left variable">error</span><span class="token operator">=</span><span class="token string">"cni config load failed: no network config found in /etc/cni/net.d: cni plugin not initialized: failed to load cni config"</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>



<h2 id="2-3-关于kubelet的cgroup-driver"><a href="#2-3-关于kubelet的cgroup-driver" class="headerlink" title="2.3 关于kubelet的cgroup driver"></a>2.3 关于kubelet的cgroup driver</h2><p>k8s官方有<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/configure-cgroup-driver/">详细的文档</a>介绍了如何设置kubelet的<code>cgroup driver</code>，需要特别注意的是，在1.22版本开始，如果没有手动设置kubelet的cgroup driver，那么默认会设置为systemd</p>
<blockquote>
<p><strong>Note:</strong> In v1.22, if the user is not setting the <code>cgroupDriver</code> field under <code>KubeletConfiguration</code>, <code>kubeadm</code> will default it to <code>systemd</code>.</p>
</blockquote>
<p>一个比较简单的指定kubelet的<code>cgroup driver</code>的方法就是在<code>kubeadm-config.yaml</code>加入<code>cgroupDriver</code>字段</p>
<div class="code-wrapper"><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># kubeadm-config.yaml</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterConfiguration
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> kubeadm.k8s.io/v1beta3
<span class="token key atrule">kubernetesVersion</span><span class="token punctuation">:</span> v1.21.0
<span class="token punctuation">---</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> KubeletConfiguration
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> kubelet.config.k8s.io/v1beta1
<span class="token key atrule">cgroupDriver</span><span class="token punctuation">:</span> systemd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>

<p>我们可以直接查看configmaps来查看初始化之后集群的kubeadm-config配置。</p>
<div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">$ kubectl describe configmaps kubeadm-config -n kube-system
Name:         kubeadm-config
Namespace:    kube-system
Labels:       &lt;none&gt;
Annotations:  &lt;none&gt;

Data
&#x3D;&#x3D;&#x3D;&#x3D;
ClusterConfiguration:
----
apiServer:
  extraArgs:
    authorization-mode: Node,RBAC
  timeoutForControlPlane: 4m0s
apiVersion: kubeadm.k8s.io&#x2F;v1beta3
certificatesDir: &#x2F;etc&#x2F;kubernetes&#x2F;pki
clusterName: kubernetes
controllerManager: &#123;&#125;
dns: &#123;&#125;
etcd:
  local:
    dataDir: &#x2F;var&#x2F;lib&#x2F;etcd
imageRepository: registry.aliyuncs.com&#x2F;google_containers
kind: ClusterConfiguration
kubernetesVersion: v1.23.6
networking:
  dnsDomain: cali-cluster.tclocal
  serviceSubnet: 10.88.0.0&#x2F;18
scheduler: &#123;&#125;


BinaryData
&#x3D;&#x3D;&#x3D;&#x3D;

Events:  &lt;none&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>

<p>当然因为我们需要安装的版本高于1.22.0并且使用的就是systemd，因此可以不用再重复配置。</p>
<h1 id="3、安装kube三件套"><a href="#3、安装kube三件套" class="headerlink" title="3、安装kube三件套"></a>3、安装kube三件套</h1><blockquote>
<p>对应的官方文档可以参考这里</p>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#installing-kubeadm-kubelet-and-kubectl">https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#installing-kubeadm-kubelet-and-kubectl</a></p>
</blockquote>
<p>kube三件套就是<code>kubeadm</code>、<code>kubelet</code> 和 <code>kubectl</code>，三者的具体功能和作用如下：</p>
<ul>
<li><code>kubeadm</code>：用来初始化集群的指令。</li>
<li><code>kubelet</code>：在集群中的每个节点上用来启动 Pod 和容器等。</li>
<li><code>kubectl</code>：用来与集群通信的命令行工具。</li>
</ul>
<p>需要注意的是：</p>
<ul>
<li><code>kubeadm</code>不会帮助我们管理<code>kubelet</code>和<code>kubectl</code>，其他两者也是一样的，也就是说这三者是相互独立的，并不存在谁管理谁的情况；</li>
<li><code>kubelet</code>的版本必须小于等于<code>API-server</code>的版本，否则容易出现兼容性的问题；</li>
<li><code>kubectl</code>并不是集群中的每个节点都需要安装，也并不是一定要安装在集群中的节点，可以单独安装在自己本地的机器环境上面，然后配合<code>kubeconfig</code>文件即可使用<code>kubectl</code>命令来远程管理对应的k8s集群；</li>
</ul>
<p>CentOS7的安装比较简单，我们直接使用官方提供的<code>yum</code>源即可。需要注意的是这里需要设置<code>selinux</code>的状态，但是前面我们已经关闭了selinux，因此这里略过这步。</p>
<div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 直接导入谷歌官方的yum源</span>
<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/yum.repos.d/kubernetes.repo</span>
[kubernetes]
name=Kubernetes
baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-\<span class="token variable">$basearch</span>
enabled=1
gpgcheck=1
repo_gpgcheck=1
gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
exclude=kubelet kubeadm kubectl
EOF</span>

<span class="token comment"># 当然如果连不上谷歌的源，可以考虑使用国内的阿里镜像源</span>
<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">></span> /etc/yum.repos.d/kubernetes.repo</span>
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/
enabled=1
gpgcheck=1
repo_gpgcheck=1
gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF</span>


<span class="token comment"># 接下来直接安装三件套即可</span>
<span class="token function">sudo</span> yum <span class="token function">install</span> -y kubelet kubeadm kubectl --disableexcludes<span class="token operator">=</span>kubernetes

<span class="token comment"># 如果网络环境不好出现gpgcheck验证失败导致无法正常读取yum源，可以考虑关闭该yum源的repo_gpgcheck</span>
<span class="token function">sed</span> -i <span class="token string">'s/repo_gpgcheck=1/repo_gpgcheck=0/g'</span> /etc/yum.repos.d/kubernetes.repo
<span class="token comment"># 或者在安装的时候禁用gpgcheck</span>
<span class="token function">sudo</span> yum <span class="token function">install</span> -y kubelet kubeadm kubectl --nogpgcheck --disableexcludes<span class="token operator">=</span>kubernetes

<span class="token comment"># 如果想要安装特定版本，可以使用这个命令查看相关版本的信息</span>
<span class="token function">sudo</span> yum list --nogpgcheck kubelet kubeadm kubectl --showduplicates --disableexcludes<span class="token operator">=</span>kubernetes


<span class="token comment"># 安装完成后配置开机自启kubelet</span>
<span class="token function">sudo</span> systemctl <span class="token builtin class-name">enable</span> --now kubelet<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>

<h1 id="4、初始化集群"><a href="#4、初始化集群" class="headerlink" title="4、初始化集群"></a>4、初始化集群</h1><h2 id="4-1-编写配置文件"><a href="#4-1-编写配置文件" class="headerlink" title="4.1 编写配置文件"></a>4.1 编写配置文件</h2><p>在集群中所有节点都执行完上面的三点操作之后，我们就可以开始创建k8s集群了。因为我们这次不涉及高可用部署，因此初始化的时候直接在我们的目标master节点上面操作即可。</p>
<div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 我们先使用kubeadm命令查看一下主要的几个镜像版本</span>
$ kubeadm config images list
k8s.gcr.io/kube-apiserver:v1.24.0
k8s.gcr.io/kube-controller-manager:v1.24.0
k8s.gcr.io/kube-scheduler:v1.24.0
k8s.gcr.io/kube-proxy:v1.24.0
k8s.gcr.io/pause:3.7
k8s.gcr.io/etcd:3.5.3-0
k8s.gcr.io/coredns/coredns:v1.8.6

<span class="token comment"># 为了方便编辑和管理，我们还是把初始化参数导出成配置文件</span>
$ kubeadm config print init-defaults <span class="token operator">></span> kubeadm-kubeproxy-free.conf
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>

<ul>
<li>考虑到大多数情况下国内的网络无法使用谷歌的k8s.gcr.io镜像源，我们可以直接在配置文件中修改<code>imageRepository</code>参数为阿里的镜像源</li>
<li><code>kubernetesVersion</code>字段用来指定我们要安装的k8s版本</li>
<li><code>localAPIEndpoint</code>参数需要修改为我们的master节点的IP和端口，初始化之后的k8s集群的apiserver地址就是这个</li>
<li><code>criSocket</code>从1.24.0版本开始已经默认变成了<code>containerd</code></li>
<li><code>podSubnet</code>、<code>serviceSubnet</code>和<code>dnsDomain</code>两个参数默认情况下可以不用修改，这里我按照自己的需求进行了变更</li>
<li><code>nodeRegistration</code>里面的<code>name</code>参数修改为对应master节点的<code>hostname</code></li>
<li>新增配置块使用ipvs，具体可以参考<a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/blob/master/pkg/proxy/ipvs/README.md#cluster-created-by-kubeadm">官方文档</a></li>
</ul>
<div class="code-wrapper"><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> kubeadm.k8s.io/v1beta3
<span class="token key atrule">bootstrapTokens</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">groups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> system<span class="token punctuation">:</span>bootstrappers<span class="token punctuation">:</span>kubeadm<span class="token punctuation">:</span>default<span class="token punctuation">-</span>node<span class="token punctuation">-</span>token
  <span class="token key atrule">token</span><span class="token punctuation">:</span> abcdef.0123456789abcdef
  <span class="token key atrule">ttl</span><span class="token punctuation">:</span> 24h0m0s
  <span class="token key atrule">usages</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> signing
  <span class="token punctuation">-</span> authentication
<span class="token key atrule">kind</span><span class="token punctuation">:</span> InitConfiguration
<span class="token key atrule">localAPIEndpoint</span><span class="token punctuation">:</span>
  <span class="token key atrule">advertiseAddress</span><span class="token punctuation">:</span> 10.31.18.1
  <span class="token key atrule">bindPort</span><span class="token punctuation">:</span> <span class="token number">6443</span>
<span class="token key atrule">nodeRegistration</span><span class="token punctuation">:</span>
  <span class="token key atrule">criSocket</span><span class="token punctuation">:</span> unix<span class="token punctuation">:</span>///var/run/containerd/containerd.sock
  <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
  <span class="token key atrule">name</span><span class="token punctuation">:</span> tiny<span class="token punctuation">-</span>kubeproxy<span class="token punctuation">-</span>free<span class="token punctuation">-</span>master<span class="token punctuation">-</span>18<span class="token punctuation">-</span>1.k8s.tcinternal
  <span class="token key atrule">taints</span><span class="token punctuation">:</span> <span class="token null important">null</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiServer</span><span class="token punctuation">:</span>
  <span class="token key atrule">timeoutForControlPlane</span><span class="token punctuation">:</span> 4m0s
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> kubeadm.k8s.io/v1beta3
<span class="token key atrule">certificatesDir</span><span class="token punctuation">:</span> /etc/kubernetes/pki
<span class="token key atrule">clusterName</span><span class="token punctuation">:</span> kubernetes
<span class="token key atrule">controllerManager</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token key atrule">dns</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token key atrule">etcd</span><span class="token punctuation">:</span>
  <span class="token key atrule">local</span><span class="token punctuation">:</span>
    <span class="token key atrule">dataDir</span><span class="token punctuation">:</span> /var/lib/etcd
<span class="token key atrule">imageRepository</span><span class="token punctuation">:</span> registry.aliyuncs.com/google_containers
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterConfiguration
<span class="token key atrule">kubernetesVersion</span><span class="token punctuation">:</span> 1.24.0
<span class="token key atrule">networking</span><span class="token punctuation">:</span>
  <span class="token key atrule">dnsDomain</span><span class="token punctuation">:</span> free<span class="token punctuation">-</span>cluster.tclocal
  <span class="token key atrule">serviceSubnet</span><span class="token punctuation">:</span> 10.18.0.0/18
  <span class="token key atrule">podSubnet</span><span class="token punctuation">:</span> 10.18.64.0/18
<span class="token key atrule">scheduler</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> kubeproxy.config.k8s.io/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> KubeProxyConfiguration
<span class="token key atrule">mode</span><span class="token punctuation">:</span> ipvs<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>

<h2 id="4-2-初始化集群"><a href="#4-2-初始化集群" class="headerlink" title="4.2 初始化集群"></a>4.2 初始化集群</h2><p>此时我们再查看对应的配置文件中的镜像版本，就会发现已经变成了对应阿里云镜像源的版本</p>
<p>参考cilium官方的<a target="_blank" rel="noopener" href="https://docs.cilium.io/en/stable/gettingstarted/kubeproxy-free/#quick-start">教程</a>我们可以在集群初始化的时候添加参数<code>--skip-phases=addon/kube-proxy</code>跳过kube-proxy的安装</p>
<div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查看一下对应的镜像版本，确定配置文件是否生效</span>
$ kubeadm config images list --config  kubeadm-kubeproxy-free.conf
registry.aliyuncs.com/google_containers/kube-apiserver:v1.24.0
registry.aliyuncs.com/google_containers/kube-controller-manager:v1.24.0
registry.aliyuncs.com/google_containers/kube-scheduler:v1.24.0
registry.aliyuncs.com/google_containers/kube-proxy:v1.24.0
registry.aliyuncs.com/google_containers/pause:3.7
registry.aliyuncs.com/google_containers/etcd:3.5.3-0
registry.aliyuncs.com/google_containers/coredns:v1.8.6

<span class="token comment"># 确认没问题之后我们直接拉取镜像</span>
$ kubeadm config images pull --config kubeadm-kubeproxy-free.conf
<span class="token punctuation">[</span>config/images<span class="token punctuation">]</span> Pulled registry.aliyuncs.com/google_containers/kube-apiserver:v1.24.0
<span class="token punctuation">[</span>config/images<span class="token punctuation">]</span> Pulled registry.aliyuncs.com/google_containers/kube-controller-manager:v1.24.0
<span class="token punctuation">[</span>config/images<span class="token punctuation">]</span> Pulled registry.aliyuncs.com/google_containers/kube-scheduler:v1.24.0
<span class="token punctuation">[</span>config/images<span class="token punctuation">]</span> Pulled registry.aliyuncs.com/google_containers/kube-proxy:v1.24.0
<span class="token punctuation">[</span>config/images<span class="token punctuation">]</span> Pulled registry.aliyuncs.com/google_containers/pause:3.7
<span class="token punctuation">[</span>config/images<span class="token punctuation">]</span> Pulled registry.aliyuncs.com/google_containers/etcd:3.5.3-0
<span class="token punctuation">[</span>config/images<span class="token punctuation">]</span> Pulled registry.aliyuncs.com/google_containers/coredns:v1.8.6

<span class="token comment"># 初始化，注意添加参数跳过kube-proxy的安装</span>
$ kubeadm init --config kubeadm-kubeproxy-free.conf --skip-phases<span class="token operator">=</span>addon/kube-proxy
<span class="token punctuation">[</span>init<span class="token punctuation">]</span> Using Kubernetes version: v1.24.0
<span class="token punctuation">[</span>preflight<span class="token punctuation">]</span> Running pre-flight checks
<span class="token punctuation">[</span>preflight<span class="token punctuation">]</span> Pulling images required <span class="token keyword">for</span> setting up a Kubernetes cluster
<span class="token punctuation">[</span>preflight<span class="token punctuation">]</span> This might take a minute or two, depending on the speed of your internet connection
<span class="token punctuation">[</span>preflight<span class="token punctuation">]</span> You can also perform this action <span class="token keyword">in</span> beforehand using <span class="token string">'kubeadm config images pull'</span>
<span class="token punctuation">..</span>.此处略去一堆输出<span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>
<p>当我们看到下面这个输出结果的时候，我们的集群就算是初始化成功了。</p>
<div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Your Kubernetes control-plane has initialized successfully<span class="token operator">!</span>

To start using your cluster, you need to run the following as a regular user:

  <span class="token function">mkdir</span> -p <span class="token environment constant">$HOME</span>/.kube
  <span class="token function">sudo</span> <span class="token function">cp</span> -i /etc/kubernetes/admin.conf <span class="token environment constant">$HOME</span>/.kube/config
  <span class="token function">sudo</span> <span class="token function">chown</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -u<span class="token variable">)</span></span><span class="token builtin class-name">:</span><span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -g<span class="token variable">)</span></span> <span class="token environment constant">$HOME</span>/.kube/config

Alternatively, <span class="token keyword">if</span> you are the root user, you can run:

  <span class="token builtin class-name">export</span> <span class="token assign-left variable">KUBECONFIG</span><span class="token operator">=</span>/etc/kubernetes/admin.conf

You should now deploy a pod network to the cluster.
Run <span class="token string">"kubectl apply -f [podnetwork].yaml"</span> with one of the options listed at:
  https://kubernetes.io/docs/concepts/cluster-administration/addons/

Then you can <span class="token function">join</span> any number of worker nodes by running the following on each as root:

kubeadm <span class="token function">join</span> <span class="token number">10.31</span>.18.1:6443 --token abcdef.0123456789abcdef <span class="token punctuation">\</span>
        --discovery-token-ca-cert-hash sha256:7772f5461bdf4dc399618dc226e2d718d35f14b079e904cd68a5b148eaefcbdd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>

<h2 id="4-3-配置kubeconfig"><a href="#4-3-配置kubeconfig" class="headerlink" title="4.3 配置kubeconfig"></a>4.3 配置kubeconfig</h2><p>刚初始化成功之后，我们还没办法马上查看k8s集群信息，需要配置kubeconfig相关参数才能正常使用kubectl连接apiserver读取集群信息。</p>
<div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 对于非root用户，可以这样操作</span>
<span class="token function">mkdir</span> -p <span class="token environment constant">$HOME</span>/.kube
<span class="token function">sudo</span> <span class="token function">cp</span> -i /etc/kubernetes/admin.conf <span class="token environment constant">$HOME</span>/.kube/config
<span class="token function">sudo</span> <span class="token function">chown</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -u<span class="token variable">)</span></span><span class="token builtin class-name">:</span><span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> -g<span class="token variable">)</span></span> <span class="token environment constant">$HOME</span>/.kube/config

<span class="token comment"># 如果是root用户，可以直接导入环境变量</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">KUBECONFIG</span><span class="token operator">=</span>/etc/kubernetes/admin.conf

<span class="token comment"># 添加kubectl的自动补全功能</span>
<span class="token builtin class-name">echo</span> <span class="token string">"source &lt;(kubectl completion bash)"</span> <span class="token operator">>></span> ~/.bashrc<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>

<blockquote>
<p>前面我们提到过<code>kubectl</code>不一定要安装在集群内，实际上只要是任何一台能连接到<code>apiserver</code>的机器上面都可以安装<code>kubectl</code>并且根据步骤配置<code>kubeconfig</code>，就可以使用<code>kubectl</code>命令行来管理对应的k8s集群。</p>
</blockquote>
<p>配置完成后，我们再执行相关命令就可以查看集群的信息了。</p>
<div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubectl cluster-info
Kubernetes control plane is running at https://10.31.18.1:6443
CoreDNS is running at https://10.31.18.1:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy

To further debug and diagnose cluster problems, use <span class="token string">'kubectl cluster-info dump'</span><span class="token builtin class-name">.</span>


$ kubectl get nodes -o wide
NAME                                             STATUS     ROLES           AGE     VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE                KERNEL-VERSION               CONTAINER-RUNTIME
tiny-kubeproxy-free-master-18-1.k8s.tcinternal   NotReady   control-plane   2m46s   v1.24.0   <span class="token number">10.31</span>.18.1    <span class="token operator">&lt;</span>none<span class="token operator">></span>        CentOS Linux <span class="token number">7</span> <span class="token punctuation">(</span>Core<span class="token punctuation">)</span>   <span class="token number">5.17</span>.6-1.el7.elrepo.x86_64   containerd://1.6.4

$ kubectl get pods -A -o wide
NAMESPACE     NAME                                                                     READY   STATUS    RESTARTS   AGE     IP           NODE
          NOMINATED NODE   READINESS GATES
kube-system   coredns-74586cf9b6-shpt4                                                 <span class="token number">0</span>/1     Pending   <span class="token number">0</span>          2m42s   <span class="token operator">&lt;</span>none<span class="token operator">></span>       <span class="token operator">&lt;</span>none<span class="token operator">></span>
          <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
kube-system   coredns-74586cf9b6-wgvgm                                                 <span class="token number">0</span>/1     Pending   <span class="token number">0</span>          2m42s   <span class="token operator">&lt;</span>none<span class="token operator">></span>       <span class="token operator">&lt;</span>none<span class="token operator">></span>
          <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
kube-system   etcd-tiny-kubeproxy-free-master-18-1.k8s.tcinternal                      <span class="token number">1</span>/1     Running   <span class="token number">0</span>          2m56s   <span class="token number">10.31</span>.18.1   tiny-kubeproxy-free-master-18-1.k8s.tcinternal   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
kube-system   kube-apiserver-tiny-kubeproxy-free-master-18-1.k8s.tcinternal            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          2m57s   <span class="token number">10.31</span>.18.1   tiny-kubeproxy-free-master-18-1.k8s.tcinternal   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
kube-system   kube-controller-manager-tiny-kubeproxy-free-master-18-1.k8s.tcinternal   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          2m55s   <span class="token number">10.31</span>.18.1   tiny-kubeproxy-free-master-18-1.k8s.tcinternal   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
kube-system   kube-scheduler-tiny-kubeproxy-free-master-18-1.k8s.tcinternal            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          2m55s   <span class="token number">10.31</span>.18.1   tiny-kubeproxy-free-master-18-1.k8s.tcinternal   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>

<span class="token comment"># 这时候查看daemonset可以看到是没有kube-proxy的</span>
$ kubectl get ds -A
No resources found<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>

<h2 id="4-4-添加worker节点"><a href="#4-4-添加worker节点" class="headerlink" title="4.4 添加worker节点"></a>4.4 添加worker节点</h2><p>这时候我们还需要继续添加剩下的两个节点作为worker节点运行负载，直接在剩下的节点上面运行集群初始化成功时输出的命令就可以成功加入集群。</p>
<p>因为我们前面的kubeadm初始化master节点的时候没有启用kube-proxy，所以在添加节点的时候会出现警告，但是不影响我们继续添加节点。</p>
<div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubeadm <span class="token function">join</span> <span class="token number">10.31</span>.18.1:6443 --token abcdef.0123456789abcdef <span class="token punctuation">\</span>
<span class="token operator">></span>         --discovery-token-ca-cert-hash sha256:7772f5461bdf4dc399618dc226e2d718d35f14b079e904cd68a5b148eaefcbdd
<span class="token punctuation">[</span>preflight<span class="token punctuation">]</span> Running pre-flight checks
<span class="token punctuation">[</span>preflight<span class="token punctuation">]</span> Reading configuration from the cluster<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>preflight<span class="token punctuation">]</span> FYI: You can <span class="token function">look</span> at this config <span class="token function">file</span> with <span class="token string">'kubectl -n kube-system get cm kubeadm-config -o yaml'</span>
W0512 <span class="token number">10</span>:34:36.673112    <span class="token number">7960</span> configset.go:78<span class="token punctuation">]</span> Warning: No kubeproxy.config.k8s.io/v1alpha1 config is loaded. Continuing without it: configmaps <span class="token string">"kube-proxy"</span> is forbidden: User <span class="token string">"system:bootstrap:abcdef"</span> cannot get resource <span class="token string">"configmaps"</span> <span class="token keyword">in</span> API group <span class="token string">""</span> <span class="token keyword">in</span> the namespace <span class="token string">"kube-system"</span>
<span class="token punctuation">[</span>kubelet-start<span class="token punctuation">]</span> Writing kubelet configuration to <span class="token function">file</span> <span class="token string">"/var/lib/kubelet/config.yaml"</span>
<span class="token punctuation">[</span>kubelet-start<span class="token punctuation">]</span> Writing kubelet environment <span class="token function">file</span> with flags to <span class="token function">file</span> <span class="token string">"/var/lib/kubelet/kubeadm-flags.env"</span>
<span class="token punctuation">[</span>kubelet-start<span class="token punctuation">]</span> Starting the kubelet
<span class="token punctuation">[</span>kubelet-start<span class="token punctuation">]</span> Waiting <span class="token keyword">for</span> the kubelet to perform the TLS Bootstrap<span class="token punctuation">..</span>.

This node has joined the cluster:
* Certificate signing request was sent to apiserver and a response was received.
* The Kubelet was informed of the new secure connection details.

Run <span class="token string">'kubectl get nodes'</span> on the control-plane to see this node <span class="token function">join</span> the cluster.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>

<p>如果不小心没保存初始化成功的输出信息也没有关系，我们可以使用kubectl工具查看或者生成token</p>
<div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查看现有的token列表</span>
$ kubeadm token list
TOKEN                     TTL         EXPIRES                USAGES                   DESCRIPTION                                                EXTRA <span class="token environment constant">GROUPS</span>
abcdef.0123456789abcdef   23h         <span class="token number">2022</span>-05-13T02:28:58Z   authentication,signing   <span class="token operator">&lt;</span>none<span class="token operator">></span>                                                     system:bootstrappers:kubeadm:default-node-token

<span class="token comment"># 如果token已经失效，那就再创建一个新的token</span>
$ kubeadm token create
ri4jzg.wkn47l10cjvefep5
$ kubeadm token list
TOKEN                     TTL         EXPIRES                USAGES                   DESCRIPTION                                                EXTRA <span class="token environment constant">GROUPS</span>
abcdef.0123456789abcdef   23h         <span class="token number">2022</span>-05-13T02:28:58Z   authentication,signing   <span class="token operator">&lt;</span>none<span class="token operator">></span>                                                     system:bootstrappers:kubeadm:default-node-token
ri4jzg.wkn47l10cjvefep5   23h         <span class="token number">2022</span>-05-13T02:40:15Z   authentication,signing   <span class="token operator">&lt;</span>none<span class="token operator">></span>                                                     system:bootstrappers:kubeadm:default-node-token

<span class="token comment"># 如果找不到--discovery-token-ca-cert-hash参数，则可以在master节点上使用openssl工具来获取</span>
$ openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt <span class="token operator">|</span> openssl rsa -pubin -outform der <span class="token operator"><span class="token file-descriptor important">2</span>></span>/dev/null <span class="token operator">|</span> openssl dgst -sha256 -hex <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">'s/^.* //'</span>
7772f5461bdf4dc399618dc226e2d718d35f14b079e904cd68a5b148eaefcbdd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>



<p>添加完成之后我们再查看集群的节点可以发现这时候已经多了两个node，但是此时节点的状态还是<code>NotReady</code>，接下来就需要部署CNI了。</p>
<div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubectl get nodes
NAME                                              STATUS     ROLES           AGE     VERSION
tiny-kubeproxy-free-master-18-1.k8s.tcinternal    NotReady   control-plane   11m     v1.24.0
tiny-kubeproxy-free-worker-18-11.k8s.tcinternal   NotReady   <span class="token operator">&lt;</span>none<span class="token operator">></span>          5m57s   v1.24.0
tiny-kubeproxy-free-worker-18-12.k8s.tcinternal   NotReady   <span class="token operator">&lt;</span>none<span class="token operator">></span>          65s     v1.24.0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>

<h1 id="5、安装CNI"><a href="#5、安装CNI" class="headerlink" title="5、安装CNI"></a>5、安装CNI</h1><h2 id="5-1-部署helm3"><a href="#5-1-部署helm3" class="headerlink" title="5.1 部署helm3"></a>5.1 部署helm3</h2><p>cilium的部署依赖helm3，因此我们在部署cilium之前需要先<a target="_blank" rel="noopener" href="https://helm.sh/docs/intro/install/">安装helm3</a>。</p>
<p>helm3的部署非常的简单，我们只要去<a target="_blank" rel="noopener" href="https://github.com/helm/helm/releases">GitHub</a>找到对应系统版本的二进制文件，下载解压后放到系统的执行目录就可以使用了。</p>
<div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">wget</span> https://get.helm.sh/helm-v3.8.2-linux-amd64.tar.gz
$ <span class="token function">tar</span> -zxvf helm-v3.8.2-linux-amd64.tar.gz
$ <span class="token function">cp</span> -rp linux-amd64/helm /usr/local/bin/
$ helm version
version.BuildInfo<span class="token punctuation">&#123;</span>Version:<span class="token string">"v3.8.2"</span>, GitCommit:<span class="token string">"6e3701edea09e5d55a8ca2aae03a68917630e91b"</span>, GitTreeState:<span class="token string">"clean"</span>, GoVersion:<span class="token string">"go1.17.5"</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>

<h2 id="5-2-部署cilium"><a href="#5-2-部署cilium" class="headerlink" title="5.2 部署cilium"></a>5.2 部署cilium</h2><p>完整的部署指南可以<a target="_blank" rel="noopener" href="https://docs.cilium.io/en/stable/gettingstarted/kubeproxy-free/">参考官方文档</a>，首先我们添加helm的repo。</p>
<div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ helm repo <span class="token function">add</span> cilium https://helm.cilium.io/
<span class="token string">"cilium"</span> has been added to your repositories
$ helm repo list
NAME    URL
cilium  https://helm.cilium.io/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>

<p>参考官网的文档，这里我们需要指定集群的APIserver的IP和端口</p>
<div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">helm install cilium .&#x2F;cilium \
    --namespace kube-system \
    --set kubeProxyReplacement&#x3D;strict \
    --set k8sServiceHost&#x3D;REPLACE_WITH_API_SERVER_IP \
    --set k8sServicePort&#x3D;REPLACE_WITH_API_SERVER_PORT<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>

<p>但是考虑到cilium默认使用的<code>podCIDR</code>为<code>10.0.0.0/8</code>，很可能会和我们集群内的网络冲突，最好的方案就是初始化的时候指定<code>podCIDR</code>，关于初始化的时候podCIDR的设置，可以参考官方的这个<a target="_blank" rel="noopener" href="https://docs.cilium.io/en/stable/gettingstarted/ipam-cluster-pool/">文章</a>。</p>
<div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">helm install cilium cilium&#x2F;cilium --version 1.11.4 \
    --namespace kube-system \
    --set kubeProxyReplacement&#x3D;strict \
    --set k8sServiceHost&#x3D;REPLACE_WITH_API_SERVER_IP \
    --set k8sServicePort&#x3D;REPLACE_WITH_API_SERVER_PORT \
	--set ipam.operator.clusterPoolIPv4PodCIDRList&#x3D;&lt;IPv4CIDR&gt; \
	--set ipam.operator.clusterPoolIPv4MaskSize&#x3D;&lt;IPv4MaskSize&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>

<p>最后可以得到我们的初始化安装参数</p>
<div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">helm install cilium cilium&#x2F;cilium --version 1.11.4 \
    --namespace kube-system \
    --set kubeProxyReplacement&#x3D;strict \
    --set k8sServiceHost&#x3D;10.31.18.1 \
    --set k8sServicePort&#x3D;6443 \
	--set ipam.operator.clusterPoolIPv4PodCIDRList&#x3D;10.18.64.0&#x2F;18 \
	--set ipam.operator.clusterPoolIPv4MaskSize&#x3D;24<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>

<p>然后我们使用指令进行安装</p>
<div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ helm <span class="token function">install</span> cilium cilium/cilium --version <span class="token number">1.11</span>.4 --namespace kube-system     --set <span class="token assign-left variable">kubeProxyReplacement</span><span class="token operator">=</span>strict --set <span class="token assign-left variable">k8sServiceHost</span><span class="token operator">=</span><span class="token number">10.31</span>.18.1 --set <span class="token assign-left variable">k8sServicePort</span><span class="token operator">=</span><span class="token number">6443</span> --set ipam.operator.clusterPoolIPv4PodCIDRList<span class="token operator">=</span><span class="token number">10.18</span>.64.0/18 --set ipam.operator.clusterPoolIPv4MaskSize<span class="token operator">=</span><span class="token number">24</span>
W0512 <span class="token number">11</span>:03:06.636996    <span class="token number">8753</span> warnings.go:70<span class="token punctuation">]</span> spec.template.spec.affinity.nodeAffinity.requiredDuringSchedulingIgnoredDuringExecution.nodeSelectorTerms<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>.matchExpressions<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>.key: beta.kubernetes.io/os is deprecated since v1.14<span class="token punctuation">;</span> use <span class="token string">"kubernetes.io/os"</span> instead
W0512 <span class="token number">11</span>:03:06.637058    <span class="token number">8753</span> warnings.go:70<span class="token punctuation">]</span> spec.template.metadata.annotations<span class="token punctuation">[</span>scheduler.alpha.kubernetes.io/critical-pod<span class="token punctuation">]</span>: non-functional <span class="token keyword">in</span> v1.16+<span class="token punctuation">;</span> use the <span class="token string">"priorityClassName"</span> field instead
NAME: cilium
LAST DEPLOYED: Thu May <span class="token number">12</span> <span class="token number">11</span>:03:04 <span class="token number">2022</span>
NAMESPACE: kube-system
STATUS: deployed
REVISION: <span class="token number">1</span>
TEST SUITE: None
NOTES:
You have successfully installed Cilium with Hubble.

Your release version is <span class="token number">1.11</span>.4.

For any further help, visit https://docs.cilium.io/en/v1.11/gettinghelp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>

<p>此时我们再查看集群的daemonset和deployment状态：</p>
<div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 这时候查看集群的daemonset和deployment状态可以看到cilium相关的服务已经正常</span>
$ kubectl get ds -A
NAMESPACE     NAME     DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE
kube-system   cilium   <span class="token number">3</span>         <span class="token number">3</span>         <span class="token number">3</span>       <span class="token number">3</span>            <span class="token number">3</span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>          4m57s
$ kubectl get deploy -A
NAMESPACE     NAME              READY   UP-TO-DATE   AVAILABLE   AGE
kube-system   cilium-operator   <span class="token number">2</span>/2     <span class="token number">2</span>            <span class="token number">2</span>           5m4s
kube-system   coredns           <span class="token number">2</span>/2     <span class="token number">2</span>            <span class="token number">2</span>           39m<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>

<p>再查看所有的pod，状态都正常，ip也和我们初始化的时候分配的ip段一致，说明初始化的参数设置生效了。</p>
<div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 再查看所有的pod，状态都正常，ip按预期进行了分配</span>
$ kubectl get pods -A -o wide
NAMESPACE     NAME                                                                     READY   STATUS    RESTARTS   AGE     IP             NODE
             NOMINATED NODE   READINESS GATES
kube-system   cilium-97fn7                                                             <span class="token number">1</span>/1     Running   <span class="token number">0</span>          7m14s   <span class="token number">10.31</span>.18.11    tiny-kubeproxy-free-worker-18-11.k8s.tcinternal   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
kube-system   cilium-k2gxc                                                             <span class="token number">1</span>/1     Running   <span class="token number">0</span>          7m14s   <span class="token number">10.31</span>.18.12    tiny-kubeproxy-free-worker-18-12.k8s.tcinternal   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
kube-system   cilium-operator-86884f4747-c2ps5                                         <span class="token number">1</span>/1     Running   <span class="token number">0</span>          7m14s   <span class="token number">10.31</span>.18.12    tiny-kubeproxy-free-worker-18-12.k8s.tcinternal   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
kube-system   cilium-operator-86884f4747-zrm4m                                         <span class="token number">1</span>/1     Running   <span class="token number">0</span>          7m14s   <span class="token number">10.31</span>.18.11    tiny-kubeproxy-free-worker-18-11.k8s.tcinternal   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
kube-system   cilium-t69js                                                             <span class="token number">1</span>/1     Running   <span class="token number">0</span>          7m14s   <span class="token number">10.31</span>.18.1     tiny-kubeproxy-free-master-18-1.k8s.tcinternal    <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
kube-system   coredns-74586cf9b6-shpt4                                                 <span class="token number">1</span>/1     Running   <span class="token number">0</span>          41m     <span class="token number">10.18</span>.65.64    tiny-kubeproxy-free-master-18-1.k8s.tcinternal    <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
kube-system   coredns-74586cf9b6-wgvgm                                                 <span class="token number">1</span>/1     Running   <span class="token number">0</span>          41m     <span class="token number">10.18</span>.65.237   tiny-kubeproxy-free-master-18-1.k8s.tcinternal    <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
kube-system   etcd-tiny-kubeproxy-free-master-18-1.k8s.tcinternal                      <span class="token number">1</span>/1     Running   <span class="token number">0</span>          41m     <span class="token number">10.31</span>.18.1     tiny-kubeproxy-free-master-18-1.k8s.tcinternal    <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
kube-system   kube-apiserver-tiny-kubeproxy-free-master-18-1.k8s.tcinternal            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          41m     <span class="token number">10.31</span>.18.1     tiny-kubeproxy-free-master-18-1.k8s.tcinternal    <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
kube-system   kube-controller-manager-tiny-kubeproxy-free-master-18-1.k8s.tcinternal   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          41m     <span class="token number">10.31</span>.18.1     tiny-kubeproxy-free-master-18-1.k8s.tcinternal    <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
kube-system   kube-scheduler-tiny-kubeproxy-free-master-18-1.k8s.tcinternal            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          41m     <span class="token number">10.31</span>.18.1     tiny-kubeproxy-free-master-18-1.k8s.tcinternal    <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>

<p>这时候我们再进入pod中检查cilium的状态</p>
<div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># --verbose参数可以查看详细的状态信息</span>
<span class="token comment"># cilium-97fn7需要替换为任意一个cilium的pod</span>
$ kubectl <span class="token builtin class-name">exec</span> -it -n kube-system cilium-97fn7 -- cilium status --verbose
Defaulted container <span class="token string">"cilium-agent"</span> out of: cilium-agent, mount-cgroup <span class="token punctuation">(</span>init<span class="token punctuation">)</span>, clean-cilium-state <span class="token punctuation">(</span>init<span class="token punctuation">)</span>
KVStore:                Ok   Disabled
Kubernetes:             Ok   <span class="token number">1.24</span> <span class="token punctuation">(</span>v1.24.0<span class="token punctuation">)</span> <span class="token punctuation">[</span>linux/amd64<span class="token punctuation">]</span>
Kubernetes APIs:        <span class="token punctuation">[</span><span class="token string">"cilium/v2::CiliumClusterwideNetworkPolicy"</span>, <span class="token string">"cilium/v2::CiliumEndpoint"</span>, <span class="token string">"cilium/v2::CiliumNetworkPolicy"</span>, <span class="token string">"cilium/v2::CiliumNode"</span>, <span class="token string">"core/v1::Namespace"</span>, <span class="token string">"core/v1::Node"</span>, <span class="token string">"core/v1::Pods"</span>, <span class="token string">"core/v1::Service"</span>, <span class="token string">"discovery/v1::EndpointSlice"</span>, <span class="token string">"networking.k8s.io/v1::NetworkPolicy"</span><span class="token punctuation">]</span>
KubeProxyReplacement:   Strict   <span class="token punctuation">[</span>eth0 <span class="token number">10.31</span>.18.11 <span class="token punctuation">(</span>Direct Routing<span class="token punctuation">)</span><span class="token punctuation">]</span>
Host firewall:          Disabled
Cilium:                 Ok   <span class="token number">1.11</span>.4 <span class="token punctuation">(</span>v1.11.4-9d25463<span class="token punctuation">)</span>
NodeMonitor:            Listening <span class="token keyword">for</span> events on <span class="token number">8</span> CPUs with 64x4096 of shared memory
Cilium health daemon:   Ok
IPAM:                   IPv4: <span class="token number">2</span>/254 allocated from <span class="token number">10.18</span>.66.0/24,
Allocated addresses:
  <span class="token number">10.18</span>.66.223 <span class="token punctuation">(</span>health<span class="token punctuation">)</span>
  <span class="token number">10.18</span>.66.232 <span class="token punctuation">(</span>router<span class="token punctuation">)</span>
BandwidthManager:       Disabled
Host Routing:           Legacy
Masquerading:           IPTables <span class="token punctuation">[</span>IPv4: Enabled, IPv6: Disabled<span class="token punctuation">]</span>
Clock Source <span class="token keyword">for</span> BPF:   ktime
Controller Status:      <span class="token number">21</span>/21 healthy
  Name                                                                          Last success   Last error   Count   Message
  bpf-map-sync-cilium_ipcache                                                   3s ago         8m59s ago    <span class="token number">0</span>       no error
  cilium-health-ep                                                              41s ago        never        <span class="token number">0</span>       no error
  dns-garbage-collector-job                                                     59s ago        never        <span class="token number">0</span>       no error
  endpoint-2503-regeneration-recovery                                           never          never        <span class="token number">0</span>       no error
  endpoint-82-regeneration-recovery                                             never          never        <span class="token number">0</span>       no error
  endpoint-gc                                                                   3m59s ago      never        <span class="token number">0</span>       no error
  ipcache-inject-labels                                                         8m49s ago      8m53s ago    <span class="token number">0</span>       no error
  k8s-heartbeat                                                                 29s ago        never        <span class="token number">0</span>       no error
  mark-k8s-node-as-available                                                    8m41s ago      never        <span class="token number">0</span>       no error
  metricsmap-bpf-prom-sync                                                      4s ago         never        <span class="token number">0</span>       no error
  resolve-identity-2503                                                         3m41s ago      never        <span class="token number">0</span>       no error
  resolve-identity-82                                                           3m42s ago      never        <span class="token number">0</span>       no error
  sync-endpoints-and-host-ips                                                   42s ago        never        <span class="token number">0</span>       no error
  sync-lb-maps-with-k8s-services                                                8m42s ago      never        <span class="token number">0</span>       no error
  sync-node-with-ciliumnode <span class="token punctuation">(</span>tiny-kubeproxy-free-worker-18-11.k8s.tcinternal<span class="token punctuation">)</span>   8m53s ago      8m55s ago    <span class="token number">0</span>       no error
  sync-policymap-2503                                                           33s ago        never        <span class="token number">0</span>       no error
  sync-policymap-82                                                             30s ago        never        <span class="token number">0</span>       no error
  sync-to-k8s-ciliumendpoint <span class="token punctuation">(</span><span class="token number">2503</span><span class="token punctuation">)</span>                                             11s ago        never        <span class="token number">0</span>       no error
  sync-to-k8s-ciliumendpoint <span class="token punctuation">(</span><span class="token number">82</span><span class="token punctuation">)</span>                                               2s ago         never        <span class="token number">0</span>       no error
  template-dir-watcher                                                          never          never        <span class="token number">0</span>       no error
  update-k8s-node-annotations                                                   8m53s ago      never        <span class="token number">0</span>       no error
Proxy Status:   OK, <span class="token function">ip</span> <span class="token number">10.18</span>.66.232, <span class="token number">0</span> redirects active on ports <span class="token number">10000</span>-20000
Hubble:         Ok   Current/Max Flows: <span class="token number">422</span>/4095 <span class="token punctuation">(</span><span class="token number">10.31</span>%<span class="token punctuation">)</span>, Flows/s: <span class="token number">0.75</span>   Metrics: Disabled
KubeProxyReplacement Details:
  Status:                 Strict
  Socket LB Protocols:    TCP, UDP
  Devices:                eth0 <span class="token number">10.31</span>.18.11 <span class="token punctuation">(</span>Direct Routing<span class="token punctuation">)</span>
  Mode:                   SNAT
  Backend Selection:      Random
  Session Affinity:       Enabled
  Graceful Termination:   Enabled
  XDP Acceleration:       Disabled
  Services:
  - ClusterIP:      Enabled
  - NodePort:       Enabled <span class="token punctuation">(</span>Range: <span class="token number">30000</span>-32767<span class="token punctuation">)</span>
  - LoadBalancer:   Enabled
  - externalIPs:    Enabled
  - HostPort:       Enabled
BPF Maps:   dynamic sizing: on <span class="token punctuation">(</span>ratio: <span class="token number">0.002500</span><span class="token punctuation">)</span>
  Name                          Size
  Non-TCP connection tracking   <span class="token number">65536</span>
  TCP connection tracking       <span class="token number">131072</span>
  Endpoint policy               <span class="token number">65535</span>
  Events                        <span class="token number">8</span>
  IP cache                      <span class="token number">512000</span>
  IP masquerading agent         <span class="token number">16384</span>
  IPv4 fragmentation            <span class="token number">8192</span>
  IPv4 <span class="token function">service</span>                  <span class="token number">65536</span>
  IPv6 <span class="token function">service</span>                  <span class="token number">65536</span>
  IPv4 <span class="token function">service</span> backend          <span class="token number">65536</span>
  IPv6 <span class="token function">service</span> backend          <span class="token number">65536</span>
  IPv4 <span class="token function">service</span> reverse NAT      <span class="token number">65536</span>
  IPv6 <span class="token function">service</span> reverse NAT      <span class="token number">65536</span>
  Metrics                       <span class="token number">1024</span>
  NAT                           <span class="token number">131072</span>
  Neighbor table                <span class="token number">131072</span>
  Global policy                 <span class="token number">16384</span>
  Per endpoint policy           <span class="token number">65536</span>
  Session affinity              <span class="token number">65536</span>
  Signal                        <span class="token number">8</span>
  Sockmap                       <span class="token number">65535</span>
  Sock reverse NAT              <span class="token number">65536</span>
  Tunnel                        <span class="token number">65536</span>
Encryption:                                                     Disabled
Cluster health:                                                 <span class="token number">3</span>/3 reachable   <span class="token punctuation">(</span><span class="token number">2022</span>-05-12T03:12:22Z<span class="token punctuation">)</span>
  Name                                                          IP              Node        Endpoints
  tiny-kubeproxy-free-worker-18-11.k8s.tcinternal <span class="token punctuation">(</span>localhost<span class="token punctuation">)</span>   <span class="token number">10.31</span>.18.11     reachable   reachable
  tiny-kubeproxy-free-master-18-1.k8s.tcinternal                <span class="token number">10.31</span>.18.1      reachable   reachable
  tiny-kubeproxy-free-worker-18-12.k8s.tcinternal               <span class="token number">10.31</span>.18.12     reachable   reachable<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>

<p>其实到这里cilium的部署就可以说是ok了的，整个集群的cni都处于正常状态，其余的工作负载也都能够正常运行了。</p>
<h2 id="5-3-部署hubble"><a href="#5-3-部署hubble" class="headerlink" title="5.3 部署hubble"></a>5.3 部署hubble</h2><p>cilium还有一大特点就是其可观测性比其他的cni要优秀很多，想要体验到cilium的可观测性，我们就需要在k8s集群中<a target="_blank" rel="noopener" href="https://docs.cilium.io/en/stable/gettingstarted/hubble_setup/#hubble-setup">安装hubble</a>。同时hubble提供了ui界面来更好的实现集群内网络的可观测性，这里我们也一并把<code>hubble-ui</code>安装上。</p>
<h3 id="helm3安装hubble"><a href="#helm3安装hubble" class="headerlink" title="helm3安装hubble"></a>helm3安装hubble</h3><p>我们继续接着上面的helm3来安装hubble，因为我们已经安装了cilium，因此这里需要使用<code>upgrade</code>来进行升级安装，并且使用<code>--reuse-values</code>来复用之前的安装参数</p>
<div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">helm upgrade cilium cilium/cilium --version <span class="token number">1.11</span>.4 <span class="token punctuation">\</span>
   --namespace kube-system <span class="token punctuation">\</span>
   --reuse-values <span class="token punctuation">\</span>
   --set hubble.relay.enabled<span class="token operator">=</span>true <span class="token punctuation">\</span>
   --set hubble.ui.enabled<span class="token operator">=</span>true<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>

<p>然后我们直接进行安装</p>
<div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ helm upgrade cilium cilium/cilium --version <span class="token number">1.11</span>.4 <span class="token punctuation">\</span>
<span class="token operator">></span>    --namespace kube-system <span class="token punctuation">\</span>
<span class="token operator">></span>    --reuse-values <span class="token punctuation">\</span>
<span class="token operator">></span>    --set hubble.relay.enabled<span class="token operator">=</span>true <span class="token punctuation">\</span>
<span class="token operator">></span>    --set hubble.ui.enabled<span class="token operator">=</span>true
Release <span class="token string">"cilium"</span> has been upgraded. Happy Helming<span class="token operator">!</span>
NAME: cilium
LAST DEPLOYED: Thu May <span class="token number">12</span> <span class="token number">11</span>:34:43 <span class="token number">2022</span>
NAMESPACE: kube-system
STATUS: deployed
REVISION: <span class="token number">2</span>
TEST SUITE: None
NOTES:
You have successfully installed Cilium with Hubble Relay and Hubble UI.

Your release version is <span class="token number">1.11</span>.4.

For any further help, visit https://docs.cilium.io/en/v1.11/gettinghelp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>

<p>随后我们查看相关的集群状态，可以看到相对应的pod、deploy和svc都工作正常</p>
<div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubectl get pod -A <span class="token operator">|</span> <span class="token function">grep</span> hubble
kube-system   hubble-relay-cdf4c8cdd-wgdqg                                             <span class="token number">1</span>/1     Running   <span class="token number">0</span>          66s
kube-system   hubble-ui-86856f9f6c-vw8lt                                               <span class="token number">3</span>/3     Running   <span class="token number">0</span>          66s
$ kubectl get deploy -A <span class="token operator">|</span> <span class="token function">grep</span> hubble
kube-system   hubble-relay      <span class="token number">1</span>/1     <span class="token number">1</span>            <span class="token number">1</span>           74s
kube-system   hubble-ui         <span class="token number">1</span>/1     <span class="token number">1</span>            <span class="token number">1</span>           74s
$ kubectl get svc -A <span class="token operator">|</span> <span class="token function">grep</span> hubble
kube-system   hubble-relay   ClusterIP   <span class="token number">10.18</span>.58.2     <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">80</span>/TCP                   82s
kube-system   hubble-ui      ClusterIP   <span class="token number">10.18</span>.22.156   <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">80</span>/TCP                   82s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>

<h3 id="cilium-cli安装hubble"><a href="#cilium-cli安装hubble" class="headerlink" title="cilium-cli安装hubble"></a>cilium-cli安装hubble</h3><p>使用cilium-cli功能来安装hubble也非常简单：</p>
<div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 首先安装cilium-cli工具</span>
<span class="token comment"># cilium的cli工具是一个二进制的可执行文件</span>
$ <span class="token function">curl</span> -L --remote-name-all https://github.com/cilium/cilium-cli/releases/latest/download/cilium-linux-amd64.tar.gz<span class="token punctuation">&#123;</span>,.sha256sum<span class="token punctuation">&#125;</span>
$ sha256sum --check cilium-linux-amd64.tar.gz.sha256sum
cilium-linux-amd64.tar.gz: OK
$ <span class="token function">sudo</span> <span class="token function">tar</span> xzvfC cilium-linux-amd64.tar.gz /usr/local/bin
cilium

<span class="token comment"># 然后直接启用hubble</span>
$ cilium hubble <span class="token builtin class-name">enable</span>
<span class="token comment"># 再启用hubble-ui</span>
$ cilium hubble <span class="token builtin class-name">enable</span> --ui
<span class="token comment"># 接着查看cilium状态</span>
$ cilium status
    /¯¯<span class="token punctuation">\</span>
 /¯¯<span class="token punctuation">\</span>__/¯¯<span class="token punctuation">\</span>    Cilium:         OK
 <span class="token punctuation">\</span>__/¯¯<span class="token punctuation">\</span>__/    Operator:       OK
 /¯¯<span class="token punctuation">\</span>__/¯¯<span class="token punctuation">\</span>    Hubble:         OK
 <span class="token punctuation">\</span>__/¯¯<span class="token punctuation">\</span>__/    ClusterMesh:    disabled
    <span class="token punctuation">\</span>__/

Deployment        cilium-operator    Desired: <span class="token number">2</span>, Ready: <span class="token number">2</span>/2, Available: <span class="token number">2</span>/2
Deployment        hubble-relay       Desired: <span class="token number">1</span>, Ready: <span class="token number">1</span>/1, Available: <span class="token number">1</span>/1
Deployment        hubble-ui          Desired: <span class="token number">1</span>, Ready: <span class="token number">1</span>/1, Available: <span class="token number">1</span>/1
DaemonSet         cilium             Desired: <span class="token number">3</span>, Ready: <span class="token number">3</span>/3, Available: <span class="token number">3</span>/3
Containers:       cilium             Running: <span class="token number">3</span>
                  cilium-operator    Running: <span class="token number">2</span>
                  hubble-relay       Running: <span class="token number">1</span>
                  hubble-ui          Running: <span class="token number">1</span>
Cluster Pods:     <span class="token number">4</span>/4 managed by Cilium
Image versions    hubble-relay       quay.io/cilium/hubble-relay:v1.11.4@sha256:460d50bd0c6bcdfa3c62b0488541c102a4079f5def07d2649ff67bc24fd0dd3f: <span class="token number">1</span>
                  hubble-ui          quay.io/cilium/hubble-ui:v0.8.5@sha256:4eaca1ec1741043cfba6066a165b3bf251590cf4ac66371c4f63fbed2224ebb4: <span class="token number">1</span>
                  hubble-ui          quay.io/cilium/hubble-ui-backend:v0.8.5@sha256:2bce50cf6c32719d072706f7ceccad654bfa907b2745a496da99610776fe31ed: <span class="token number">1</span>
                  hubble-ui          docker.io/envoyproxy/envoy:v1.18.4@sha256:e5c2bb2870d0e59ce917a5100311813b4ede96ce4eb0c6bfa879e3fbe3e83935: <span class="token number">1</span>
                  cilium             quay.io/cilium/cilium:v1.11.4@sha256:d9d4c7759175db31aa32eaa68274bb9355d468fbc87e23123c80052e3ed63116: <span class="token number">3</span>
                  cilium-operator    quay.io/cilium/operator-generic:v1.11.4@sha256:bf75ad0dc47691a3a519b8ab148ed3a792ffa2f1e309e6efa955f30a40e95adc: <span class="token number">2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>

<h3 id="安装hubble客户端"><a href="#安装hubble客户端" class="headerlink" title="安装hubble客户端"></a>安装hubble客户端</h3><p>和cilium一样，hubble也提供了一个客户端来让我们操作，不同的是我们</p>
<div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 首先我们需要安装hubble的客户端，安装原理和过程与安装cilium几乎一致</span>
$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">HUBBLE_VERSION</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">curl</span> -s https://raw.githubusercontent.com/cilium/hubble/master/stable.txt<span class="token variable">)</span></span>
$ <span class="token function">curl</span> -L --remote-name-all https://github.com/cilium/hubble/releases/download/<span class="token variable">$HUBBLE_VERSION</span>/hubble-linux-amd64.tar.gz<span class="token punctuation">&#123;</span>,.sha256sum<span class="token punctuation">&#125;</span>
$ sha256sum --check hubble-linux-amd64.tar.gz.sha256sum
$ <span class="token function">sudo</span> <span class="token function">tar</span> xzvfC hubble-linux-amd64.tar.gz /usr/local/bin
$ <span class="token function">rm</span> hubble-linux-amd64.tar.gz<span class="token punctuation">&#123;</span>,.sha256sum<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>

<p>然后我们需要暴露hubble api服务的端口，直接使用kubectl的port-forward功能把hubble-relay这个服务的80端口暴露到4245端口上</p>
<div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 仅暴露在IPV4网络中</span>
$ kubectl port-forward -n kube-system svc/hubble-relay --address <span class="token number">0.0</span>.0.0 <span class="token number">4245</span>:80 <span class="token operator">&amp;</span>
<span class="token comment"># 同时暴露在IPV6和IPV4网络中</span>
$ kubectl port-forward -n kube-system svc/hubble-relay --address <span class="token number">0.0</span>.0.0 --address :: <span class="token number">4245</span>:80 <span class="token operator">&amp;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></div>

<p>如果使用cilium-cli工具安装的hubble也可以使用cilium暴露api端口，需要注意的是该命令默认会暴露到IPV6和IPV4网络中，如果宿主机节点不支持ipv6网络会报错</p>
<div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ cilium hubble port-forward<span class="token operator">&amp;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></div>

<p>api端口暴露完成之后我们就可以测试一下hubble客户端的工作状态是否正常</p>
<div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">$ hubble status
Handling connection for 4245
Healthcheck (via localhost:4245): Ok
Current&#x2F;Max Flows: 10,903&#x2F;12,285 (88.75%)
Flows&#x2F;s: 5.98
Connected Nodes: 3&#x2F;3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>

<h3 id="暴露hubble-ui"><a href="#暴露hubble-ui" class="headerlink" title="暴露hubble-ui"></a>暴露hubble-ui</h3><p>官方介绍里面是使用cilium工具直接暴露hubble-ui的访问端口到宿主机上面的12000端口</p>
<div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 将hubble-ui这个服务的80端口暴露到宿主机上面的12000端口上面</span>
$ cilium hubble ui<span class="token operator">&amp;</span>
<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token number">5809</span>
ℹ️  Opening <span class="token string">"http://localhost:12000"</span> <span class="token keyword">in</span> your browser<span class="token punctuation">..</span>.
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></div>

<p>实际上执行的操作等同于下面这个命令</p>
<div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 同时暴露在IPV6和IPV4网络中</span>
<span class="token comment"># kubectl port-forward -n kube-system svc/hubble-ui --address 0.0.0.0 --address :: 12000:80</span>

<span class="token comment"># 仅暴露在IPV4网络中</span>
<span class="token comment"># kubectl port-forward -n kube-system svc/hubble-ui --address 0.0.0.0 12000:80</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>

<p>这里我们使用nodeport的方式来暴露hubble-ui，首先我们查看原来的<code>hubble-ui</code>这个svc的配置</p>
<div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubectl get svc -n kube-system hubble-ui -o yaml
<span class="token punctuation">..</span>.此处略去一堆输出<span class="token punctuation">..</span>.
  - name: http
    port: <span class="token number">80</span>
    protocol: TCP
    targetPort: <span class="token number">8081</span>
  selector:
    k8s-app: hubble-ui
  sessionAffinity: None
  type: ClusterIP
<span class="token punctuation">..</span>.此处略去一堆输出<span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>

<p>我们把默认的ClusterIP修改为<code>NodePort</code>，并且指定端口为<code>nodePort: 30081</code></p>
<div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubectl get svc -n kube-system hubble-ui -o yaml
<span class="token punctuation">..</span>.此处略去一堆输出<span class="token punctuation">..</span>.
  ports:
  - name: http
    nodePort: <span class="token number">30081</span>
    port: <span class="token number">80</span>
    protocol: TCP
    targetPort: <span class="token number">8081</span>
  selector:
    k8s-app: hubble-ui
  sessionAffinity: None
  type: NodePort
<span class="token punctuation">..</span>.此处略去一堆输出<span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>

<p>修改前后对比查看状态</p>
<div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 修改前，使用ClusterIP</span>
$ kubectl get svc -A <span class="token operator">|</span> <span class="token function">grep</span> hubble-ui
kube-system   hubble-ui      ClusterIP   <span class="token number">10.18</span>.22.156   <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">80</span>/TCP                   82s

<span class="token comment"># 修改后，使用NodePort</span>
$ kubectl get svc -A <span class="token operator">|</span> <span class="token function">grep</span> hubble-ui
kube-system   hubble-ui      NodePort    <span class="token number">10.18</span>.22.156   <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">80</span>:30081/TCP             47m<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>

<p>这时候我们在浏览器中访问<code>http://10.31.18.1:30081</code>就可以看到hubble的ui界面了</p>
<p><img src="https://resource.tinychen.com/202205121217040.png" srcset="/img/loading.gif" lazyload></p>
<h1 id="6、部署测试用例"><a href="#6、部署测试用例" class="headerlink" title="6、部署测试用例"></a>6、部署测试用例</h1><p>集群部署完成之后我们在k8s集群中部署一个nginx测试一下是否能够正常工作。首先我们创建一个名为<code>nginx-quic</code>的命名空间（<code>namespace</code>），然后在这个命名空间内创建一个名为<code>nginx-quic-deployment</code>的<code>deployment</code>用来部署pod，最后再创建一个<code>service</code>用来暴露服务，这里我们先使用<code>nodeport</code>的方式暴露端口方便测试。</p>
<div class="code-wrapper"><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">$ cat nginx<span class="token punctuation">-</span>quic.yaml
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Namespace
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>quic

<span class="token punctuation">---</span>

<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>quic<span class="token punctuation">-</span>deployment
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>quic
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>quic
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">4</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>quic
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>quic
        <span class="token key atrule">image</span><span class="token punctuation">:</span> tinychen777/nginx<span class="token punctuation">-</span>quic<span class="token punctuation">:</span>latest
        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>

<span class="token punctuation">---</span>

<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>quic<span class="token punctuation">-</span>service
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>quic
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">externalTrafficPolicy</span><span class="token punctuation">:</span> Cluster
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>quic
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span> <span class="token comment"># match for service access port</span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span> <span class="token comment"># match for pod access port</span>
    <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">30088</span> <span class="token comment"># match for external access port</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>

<p>部署完成后我们直接查看状态</p>
<div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 直接部署</span>
$ kubectl apply -f nginx-quic.yaml
namespace/nginx-quic created
deployment.apps/nginx-quic-deployment created
service/nginx-quic-service created

<span class="token comment"># 查看deployment的运行状态</span>
$ kubectl get deployment -o wide -n nginx-quic
NAME                    READY   UP-TO-DATE   AVAILABLE   AGE     CONTAINERS   IMAGES                          SELECTOR
nginx-quic-deployment   <span class="token number">4</span>/4     <span class="token number">4</span>            <span class="token number">4</span>           2m49s   nginx-quic   tinychen777/nginx-quic:latest   <span class="token assign-left variable">app</span><span class="token operator">=</span>nginx-quic

<span class="token comment"># 查看service的运行状态</span>
$ kubectl get <span class="token function">service</span> -o wide -n nginx-quic
NAME                 TYPE       CLUSTER-IP     EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>          AGE   SELECTOR
nginx-quic-service   NodePort   <span class="token number">10.18</span>.54.119   <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">8080</span>:30088/TCP   3m    <span class="token assign-left variable">app</span><span class="token operator">=</span>nginx-quic

<span class="token comment"># 查看pod的运行状态</span>
$ kubectl get pods -o wide -n nginx-quic
NAME                                     READY   STATUS    RESTARTS   AGE     IP             NODE                                              NOMINATED NODE   READINESS GATES
nginx-quic-deployment-5d9b4fbb47-4gc6g   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          3m10s   <span class="token number">10.18</span>.66.66    tiny-kubeproxy-free-worker-18-11.k8s.tcinternal   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
nginx-quic-deployment-5d9b4fbb47-4j5p6   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          3m10s   <span class="token number">10.18</span>.64.254   tiny-kubeproxy-free-worker-18-12.k8s.tcinternal   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
nginx-quic-deployment-5d9b4fbb47-8gg9j   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          3m10s   <span class="token number">10.18</span>.66.231   tiny-kubeproxy-free-worker-18-11.k8s.tcinternal   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>
nginx-quic-deployment-5d9b4fbb47-9bv2t   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          3m10s   <span class="token number">10.18</span>.64.5     tiny-kubeproxy-free-worker-18-12.k8s.tcinternal   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>

<span class="token comment"># 查看IPVS规则</span>
<span class="token comment"># 由于使用了cilium的kube-proxy-free方案，这时候Linux网络中是没有ipvs规则的</span>
$ ipvsadm -ln
IP Virtual Server version <span class="token number">1.2</span>.1 <span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">4096</span><span class="token punctuation">)</span>
Prot LocalAddress:Port Scheduler Flags
  -<span class="token operator">></span> RemoteAddress:Port           Forward Weight ActiveConn InActConn
  
<span class="token comment"># 查看cilium里面的状态</span>
$ kubectl <span class="token builtin class-name">exec</span> -it -n kube-system cilium-97fn7 -- cilium <span class="token function">service</span> list
Defaulted container <span class="token string">"cilium-agent"</span> out of: cilium-agent, mount-cgroup <span class="token punctuation">(</span>init<span class="token punctuation">)</span>, clean-cilium-state <span class="token punctuation">(</span>init<span class="token punctuation">)</span>
ID   Frontend            Service Type   Backend
<span class="token number">1</span>    <span class="token number">10.18</span>.0.1:443       ClusterIP      <span class="token number">1</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token number">10.31</span>.18.1:6443
<span class="token number">2</span>    <span class="token number">10.18</span>.0.10:9153     ClusterIP      <span class="token number">1</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token number">10.18</span>.65.237:9153
                                        <span class="token number">2</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token number">10.18</span>.65.64:9153
<span class="token number">3</span>    <span class="token number">10.18</span>.0.10:53       ClusterIP      <span class="token number">1</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token number">10.18</span>.65.237:53
                                        <span class="token number">2</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token number">10.18</span>.65.64:53
<span class="token number">4</span>    <span class="token number">10.18</span>.22.156:80     ClusterIP      <span class="token number">1</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token number">10.18</span>.64.53:8081
<span class="token number">5</span>    <span class="token number">10.18</span>.58.2:80       ClusterIP      <span class="token number">1</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token number">10.18</span>.66.189:4245
<span class="token number">6</span>    <span class="token number">10.31</span>.18.11:30081   NodePort       <span class="token number">1</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token number">10.18</span>.64.53:8081
<span class="token number">7</span>    <span class="token number">0.0</span>.0.0:30081       NodePort       <span class="token number">1</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token number">10.18</span>.64.53:8081
<span class="token number">8</span>    <span class="token number">10.18</span>.54.119:8080   ClusterIP      <span class="token number">1</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token number">10.18</span>.64.254:80
                                        <span class="token number">2</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token number">10.18</span>.66.66:80
                                        <span class="token number">3</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token number">10.18</span>.64.5:80
                                        <span class="token number">4</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token number">10.18</span>.66.231:80
<span class="token number">9</span>    <span class="token number">10.31</span>.18.11:30088   NodePort       <span class="token number">1</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token number">10.18</span>.64.254:80
                                        <span class="token number">2</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token number">10.18</span>.66.66:80
                                        <span class="token number">3</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token number">10.18</span>.64.5:80
                                        <span class="token number">4</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token number">10.18</span>.66.231:80
<span class="token number">10</span>   <span class="token number">0.0</span>.0.0:30088       NodePort       <span class="token number">1</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token number">10.18</span>.64.254:80
                                        <span class="token number">2</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token number">10.18</span>.66.66:80
                                        <span class="token number">3</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token number">10.18</span>.64.5:80
                                        <span class="token number">4</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token number">10.18</span>.66.231:80<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>

<p>最后我们进行测试，这个nginx-quic的镜像默认情况下会返回在nginx容器中获得的用户请求的IP和端口</p>
<div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 首先我们在集群内进行测试</span>
<span class="token comment"># 直接访问pod</span>
$ <span class="token function">curl</span> <span class="token number">10.18</span>.64.254:80
<span class="token number">10.18</span>.65.204:60032
<span class="token comment"># 直接访问service的ClusterIP，这时请求会被转发到pod中</span>
$ <span class="token function">curl</span> <span class="token number">10.18</span>.54.119:8080
<span class="token number">10.18</span>.65.204:38774

<span class="token comment"># 直接访问nodeport，这时请求会被转发到pod中，不会经过ClusterIP</span>
<span class="token comment"># 此时实际返回的IP要取决于被转发到的后端pod是否在当前的k8s节点上</span>
$ <span class="token function">curl</span> <span class="token number">10.31</span>.18.1:30088
<span class="token number">10.18</span>.65.204:51254
$ <span class="token function">curl</span> <span class="token number">10.31</span>.18.11:30088
<span class="token number">10.18</span>.65.204:38784
$ <span class="token function">curl</span> <span class="token number">10.31</span>.18.12:30088
<span class="token number">10.18</span>.65.204:60048

<span class="token comment"># 接着我们在集群外进行测试</span>
<span class="token comment"># 直接访问三个节点的nodeport，这时请求会被转发到pod中，不会经过ClusterIP</span>
<span class="token comment"># 此时实际返回的IP要取决于被转发到的后端pod是否在当前的k8s节点上</span>
$ <span class="token function">curl</span> <span class="token number">10.31</span>.18.1:30088
<span class="token number">10.18</span>.65.204:43586
$ <span class="token function">curl</span> <span class="token number">10.31</span>.18.11:30088
<span class="token number">10.18</span>.66.232:63415
$ <span class="token function">curl</span> <span class="token number">10.31</span>.18.11:30088
<span class="token number">10.31</span>.100.100:12192
$ <span class="token function">curl</span> <span class="token number">10.31</span>.18.12:30088
<span class="token number">10.18</span>.64.152:40782
$ <span class="token function">curl</span> <span class="token number">10.31</span>.18.12:30088
<span class="token number">10.31</span>.100.100:12178<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>










              
            </div>
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/cloudnative/" class="category-chain-item">cloudnative</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/centos/">#centos</a>
      
        <a href="/tags/k8s/">#k8s</a>
      
        <a href="/tags/docker/">#docker</a>
      
        <a href="/tags/cilium/">#cilium</a>
      
        <a href="/tags/containerd/">#containerd</a>
      
    </div>
  
</div>


              

              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/20220510-k8s-04-deploy-k8s-with-cilium/" title="k8s系列04-kubeadm部署cilium网络的k8s集群">
                        <span class="hidden-mobile">k8s系列04-kubeadm部署cilium网络的k8s集群</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;Table of Contents</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  






    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">Keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <i class="iconfont icon-copyright"></i> <a href="https://tinychen.com/" target="_blank" rel="nofollow noopener"><span>2017~2022 By TinyChen </span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Hexo-Fluid</span></a> 
    </div>
  
  
  
    <!-- 备案信息 ICP for China -->
    <div class="beian">
  <span>
    <a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">
      粤ICP备18140640号
    </a>
  </span>
  
</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <!-- Baidu Analytics -->
    <script defer>
      if (!Fluid.ctx.dnt) {
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?7a96963a1145ac7fde1442d739a11ffd";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
      }
    </script>
  

  
    <!-- Google Analytics -->
    <script defer>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript('https://www.google-analytics.com/analytics.js', function() {
          window.ga = window.ga || function() { (ga.q = ga.q || []).push(arguments) };
          ga.l = +new Date;
          ga('create', 'UA-166769908-1', 'auto');
          ga('send', 'pageview');
        });
      }
    </script>
  

  

  

  

  

  




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.0/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script  src="https://lib.baomitu.com/prism/1.26.0/plugins/line-numbers/prism-line-numbers.min.js" ></script>

  <script>
  (function() {
    var enableLang = CONFIG.code_language.enable && CONFIG.code_language.default;
    var enableCopy = CONFIG.copy_btn;
    if (!enableLang && !enableCopy) {
      return;
    }

    function getBgClass(ele) {
      return Fluid.utils.getBackgroundLightness(ele) >= 0 ? 'code-widget-light' : 'code-widget-dark';
    }

    var copyTmpl = '';
    copyTmpl += '<div class="code-widget">';
    copyTmpl += 'LANG';
    copyTmpl += '</div>';
    jQuery('.markdown-body pre').each(function() {
      var $pre = jQuery(this);
      if ($pre.find('code.mermaid').length > 0) {
        return;
      }
      if ($pre.find('span.line').length > 0) {
        return;
      }

      var lang = '';

      if (enableLang) {
        lang = CONFIG.code_language.default;
        if ($pre[0].children.length > 0 && $pre[0].children[0].classList.length >= 2 && $pre.children().hasClass('hljs')) {
          lang = $pre[0].children[0].classList[1];
        } else if ($pre[0].getAttribute('data-language')) {
          lang = $pre[0].getAttribute('data-language');
        } else if ($pre.parent().hasClass('sourceCode') && $pre[0].children.length > 0 && $pre[0].children[0].classList.length >= 2) {
          lang = $pre[0].children[0].classList[1];
          $pre.parent().addClass('code-wrapper');
        } else if ($pre.parent().hasClass('markdown-body') && $pre[0].classList.length === 0) {
          $pre.wrap('<div class="code-wrapper"></div>');
        }
        lang = lang.toUpperCase().replace('NONE', CONFIG.code_language.default);
      }
      $pre.append(copyTmpl.replace('LANG', lang).replace('code-widget">',
        getBgClass($pre[0]) + (enableCopy ? ' code-widget copy-btn" data-clipboard-snippet><i class="iconfont icon-copy"></i>' : ' code-widget">')));

      if (enableCopy) {
        Fluid.utils.createScript('https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js', function() {
          var clipboard = new window.ClipboardJS('.copy-btn', {
            target: function(trigger) {
              var nodes = trigger.parentNode.childNodes;
              for (var i = 0; i < nodes.length; i++) {
                if (nodes[i].tagName === 'CODE') {
                  return nodes[i];
                }
              }
            }
          });
          clipboard.on('success', function(e) {
            e.clearSelection();
            e.trigger.innerHTML = e.trigger.innerHTML.replace('icon-copy', 'icon-success');
            setTimeout(function() {
              e.trigger.innerHTML = e.trigger.innerHTML.replace('icon-success', 'icon-copy');
            }, 2000);
          });
        });
      }
    });
  })();
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">Blog works best with JavaScript enabled</div>
  </noscript>
</body>
</html>
