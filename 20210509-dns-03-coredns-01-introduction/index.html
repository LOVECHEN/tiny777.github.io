

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="https://resource.tinychen.com/logos.png">
  <link rel="icon" href="https://resource.tinychen.com/logos.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="TinyChen">
  <meta name="keywords" content="">
  
    <meta name="description" content="本文主要对coredns的原理和特性进行介绍，同时会对其二进制的安装方法进行尝试。">
<meta property="og:type" content="article">
<meta property="og:title" content="CoreDNS篇1-简介和安装">
<meta property="og:url" content="https://tinychen.com/20210509-dns-03-coredns-01-introduction/index.html">
<meta property="og:site_name" content="TinyChen&#39;s Studio">
<meta property="og:description" content="本文主要对coredns的原理和特性进行介绍，同时会对其二进制的安装方法进行尝试。">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://resource.tinychen.com/20210512164201s.jpg">
<meta property="article:published_time" content="2021-05-09T03:00:00.000Z">
<meta property="article:modified_time" content="2021-05-09T03:00:00.000Z">
<meta property="article:author" content="TinyChen">
<meta property="article:tag" content="dns">
<meta property="article:tag" content="coredns">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://resource.tinychen.com/20210512164201s.jpg">
  
  
  <title>CoreDNS篇1-简介和安装 - TinyChen&#39;s Studio</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/prism/1.26.0/plugins/line-numbers/prism-line-numbers.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"tinychen.com","root":"/","version":"1.8.14","typing":{"enable":true,"typeSpeed":30,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"bash"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":1},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":"7a96963a1145ac7fde1442d739a11ffd","google":"UA-166769908-1","gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>

  
<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="TinyChen's Studio" type="application/atom+xml">
</head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>TinyChen</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archives
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                Categories
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                Tags
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                Links
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('https://resource.tinychen.com/20210512164201.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="CoreDNS篇1-简介和安装"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2021-05-09 11:00" pubdate>
          May 9, 2021 am
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          7.1k words
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          60 mins
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">CoreDNS篇1-简介和安装</h1>
            
              <p class="note note-info">
                
                  
                    Last updated on May 9, 2021 am
                  
                
              </p>
            
            <div class="markdown-body">
              
              <p>本文主要对coredns的原理和特性进行介绍，同时会对其二进制的安装方法进行尝试。</p>
<span id="more"></span>

<h1 id="1、coredns简介"><a href="#1、coredns简介" class="headerlink" title="1、coredns简介"></a>1、coredns简介</h1><p>coredns是一个用go语言编写的开源的DNS服务，它的官网可以点击<a target="_blank" rel="noopener" href="https://coredns.io/">这里</a>，github页面可以点击<a target="_blank" rel="noopener" href="https://github.com/coredns/coredns">这里</a>。需要额外注意的是，coredns是首批加入<a target="_blank" rel="noopener" href="https://www.cncf.io/">CNCF</a>组织的云原生开源项目，并且作为已经在CNCF毕业的项目，coredns还是目前kubernetes中默认的dns服务。同时，由于coredns可以集成插件，它还能够实现服务发现的功能。</p>
<p>coredns和其他的诸如bind、knot、powerdns、unbound等DNS服务不同的是：coredns非常的灵活，并且几乎把所有的核心功能实现都外包给了插件。比如说如果你想要在coredns中加入Prometheus的监控支持，那么只需要安装对应的prometheus插件并且启用即可，因此官方也说coredns是由插件驱动的。</p>
<blockquote>
<p><em>CoreDNS is powered by plugins.</em></p>
</blockquote>
<p>对于coredns插件的定义，官网是这样表示的：<strong>插件是能够单独或者共同实现一个“DNS的功能（DNS function）”</strong>。</p>
<blockquote>
<p>Plugins can be stand-alone or work together to perform a “DNS function”.</p>
<p>So what’s a “DNS function”? For the purpose of CoreDNS, we define it as a piece of software that implements the CoreDNS Plugin API. The functionality implemented can wildly deviate. There are plugins that don’t themselves create a response, such as <a target="_blank" rel="noopener" href="https://coredns.io/plugins/metrics">metrics</a> or <a target="_blank" rel="noopener" href="https://coredns.io/plugins/cache">cache</a>, but that add functionality. Then there are plugins that <em>do</em> generate a response. These can also do anything: There are plugins that communicate with <a target="_blank" rel="noopener" href="https://coredns.io/plugins/kubernetes">Kubernetes</a> to provide service discovery, plugins that read data from a <a target="_blank" rel="noopener" href="https://coredns.io/plugins/file">file</a> or a <a target="_blank" rel="noopener" href="https://coredns.io/explugins/pdsql">database</a>.</p>
</blockquote>
<h1 id="2、coredns安装"><a href="#2、coredns安装" class="headerlink" title="2、coredns安装"></a>2、coredns安装</h1><p>和大多数的软件一样，<strong>coredns提供了源码编译、预编译包和docker镜像三种安装方式</strong>。这里我们使用预编译包的方式进行安装。coredns在<a target="_blank" rel="noopener" href="https://github.com/coredns/coredns/releases/">github</a>上面提供了各种版本的预编译包，我们只需要下载对应的硬件版本即可。</p>
<p>解压对应的版本后可以得到一个二进制文件，直接执行就可以使用。</p>
<div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">$ .&#x2F;coredns --help
Usage of .&#x2F;coredns:
  -conf string
        Corefile to load (default &quot;Corefile&quot;)
  -dns.port string
        Default port (default &quot;53&quot;)
  -pidfile string
        Path to write pid file
  -plugins
        List installed plugins
  -quiet
        Quiet mode (no initialization output)
  -version
        Show version<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>

<p>需要注意的是，对于预编译的版本，会内置全部官方认证的插件，也就是官网的<a target="_blank" rel="noopener" href="https://coredns.io/plugins/">插件页面</a>列出来的全部插件</p>
<div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">$ .&#x2F;coredns -plugins
Server types:
  dns

Caddyfile loaders:
  flag
  default

Other plugins:
  dns.acl
  dns.any
  dns.auto
  dns.autopath
  dns.azure
  dns.bind
  dns.bufsize
  dns.cache
  dns.cancel
  dns.chaos
  dns.clouddns
  dns.debug
  dns.dns64
  dns.dnssec
  dns.dnstap
  dns.erratic
  dns.errors
  dns.etcd
  dns.file
  dns.forward
  dns.grpc
  dns.health
  dns.hosts
  dns.k8s_external
  dns.kubernetes
  dns.loadbalance
  dns.local
  dns.log
  dns.loop
  dns.metadata
  dns.nsid
  dns.pprof
  dns.prometheus
  dns.ready
  dns.reload
  dns.rewrite
  dns.root
  dns.route53
  dns.secondary
  dns.sign
  dns.template
  dns.tls
  dns.trace
  dns.transfer
  dns.whoami
  on<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>

<p>coredns的运行也非常简单，直接运行二进制文件即可，默认情况下可以添加的参数不多，主要是指定配置文件，指定运行端口和设置quiet模式。</p>
<div class="code-wrapper"><pre class="line-numbers language-none"><code class="language-none">$ .&#x2F;coredns
.:53
CoreDNS-1.8.3
linux&#x2F;amd64, go1.16, 4293992<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></div>

<p>默认情况下会直接监听53端口，并且读取和自己在相同目录下的Corefile配置文件。但是在这种情况下，虽然coredns正常运行了，但是由于没有配置文件，是无法正常解析任何域名请求的。</p>
<div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 直接运行coredns让其监听30053端口</span>
$ ./coredns -dns.port <span class="token number">30053</span>
.:30053
CoreDNS-1.8.3
linux/amd64, go1.16, <span class="token number">4293992</span>
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token number">127.0</span>.0.1:47910 - <span class="token number">63992</span> <span class="token string">"A IN tinychen.com. udp 53 false 4096"</span> NOERROR qr,aa,rd <span class="token number">94</span> <span class="token number">0</span>.000162476s
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token number">127.0</span>.0.1:48764 - <span class="token number">26598</span> <span class="token string">"A IN tinychen.com. udp 53 false 4096"</span> NOERROR qr,aa,rd <span class="token number">94</span> <span class="token number">0</span>.000135895s

<span class="token comment"># 使用dig命令进行测试，发现能够正常返回请求但是解析的结果不正确</span>
$ <span class="token function">dig</span> tinychen.com @127.0.0.1 -p30053

<span class="token punctuation">;</span> <span class="token operator">&lt;&lt;</span><span class="token operator">>></span> DiG <span class="token number">9.11</span>.20-RedHat-9.11.20-5.el8_3.1 <span class="token operator">&lt;&lt;</span><span class="token operator">>></span> tinychen.com @127.0.0.1 -p30053
<span class="token punctuation">;</span><span class="token punctuation">;</span> global options: +cmd
<span class="token punctuation">;</span><span class="token punctuation">;</span> Got answer:
<span class="token punctuation">;</span><span class="token punctuation">;</span> -<span class="token operator">>></span>HEADER<span class="token operator">&lt;&lt;-</span> opcode: QUERY, status: NOERROR, id: <span class="token number">26598</span>
<span class="token punctuation">;</span><span class="token punctuation">;</span> flags: qr aa rd<span class="token punctuation">;</span> QUERY: <span class="token number">1</span>, ANSWER: <span class="token number">0</span>, AUTHORITY: <span class="token number">0</span>, ADDITIONAL: <span class="token number">3</span>
<span class="token punctuation">;</span><span class="token punctuation">;</span> WARNING: recursion requested but not available

<span class="token punctuation">;</span><span class="token punctuation">;</span> OPT PSEUDOSECTION:
<span class="token punctuation">;</span> EDNS: version: <span class="token number">0</span>, flags:<span class="token punctuation">;</span> udp: <span class="token number">4096</span>
<span class="token punctuation">;</span> COOKIE: 4429aa454c031afe <span class="token punctuation">(</span>echoed<span class="token punctuation">)</span>
<span class="token punctuation">;</span><span class="token punctuation">;</span> QUESTION SECTION:
<span class="token punctuation">;</span>tinychen.com.                  IN      A

<span class="token punctuation">;</span><span class="token punctuation">;</span> ADDITIONAL SECTION:
tinychen.com.           <span class="token number">0</span>       IN      A       <span class="token number">127.0</span>.0.1
_udp.tinychen.com.      <span class="token number">0</span>       IN      SRV     <span class="token number">0</span> <span class="token number">0</span> <span class="token number">48764</span> <span class="token builtin class-name">.</span>

<span class="token punctuation">;</span><span class="token punctuation">;</span> Query time: <span class="token number">0</span> msec
<span class="token punctuation">;</span><span class="token punctuation">;</span> SERVER: <span class="token number">127.0</span>.0.1<span class="token comment">#30053(127.0.0.1)</span>
<span class="token punctuation">;</span><span class="token punctuation">;</span> WHEN: Tue May <span class="token number">11</span> <span class="token number">11</span>:39:47 CST <span class="token number">2021</span>
<span class="token punctuation">;</span><span class="token punctuation">;</span> MSG SIZE  rcvd: <span class="token number">117</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>

<p>这里我们简单编写一个Corefile配置文件就能够先让coredns正常解析域名，这个配置文件的意识是对所有域的请求都forward到114DNS进行解析，并且记录正常的日志和错误的日志。</p>
<div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">cat</span> Corefile
<span class="token builtin class-name">.</span> <span class="token punctuation">&#123;</span>
    forward <span class="token builtin class-name">.</span> <span class="token number">114.114</span>.114.114 <span class="token number">223.5</span>.5.5
    log
    errors
    <span class="token function">whoami</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>

<p>然后我们再进行测试就发现coredns可以正常解析域名了：</p>
<div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">dig</span> tinychen.com @127.0.0.1 -p30053

<span class="token punctuation">;</span> <span class="token operator">&lt;&lt;</span><span class="token operator">>></span> DiG <span class="token number">9.11</span>.20-RedHat-9.11.20-5.el8_3.1 <span class="token operator">&lt;&lt;</span><span class="token operator">>></span> tinychen.com @127.0.0.1 -p30053
<span class="token punctuation">;</span><span class="token punctuation">;</span> global options: +cmd
<span class="token punctuation">;</span><span class="token punctuation">;</span> Got answer:
<span class="token punctuation">;</span><span class="token punctuation">;</span> -<span class="token operator">>></span>HEADER<span class="token operator">&lt;&lt;-</span> opcode: QUERY, status: NOERROR, id: <span class="token number">49732</span>
<span class="token punctuation">;</span><span class="token punctuation">;</span> flags: qr rd ra<span class="token punctuation">;</span> QUERY: <span class="token number">1</span>, ANSWER: <span class="token number">1</span>, AUTHORITY: <span class="token number">0</span>, ADDITIONAL: <span class="token number">1</span>

<span class="token punctuation">;</span><span class="token punctuation">;</span> OPT PSEUDOSECTION:
<span class="token punctuation">;</span> EDNS: version: <span class="token number">0</span>, flags:<span class="token punctuation">;</span> udp: <span class="token number">4096</span>
<span class="token punctuation">;</span><span class="token punctuation">;</span> QUESTION SECTION:
<span class="token punctuation">;</span>tinychen.com.                  IN      A

<span class="token punctuation">;</span><span class="token punctuation">;</span> ANSWER SECTION:
tinychen.com.           <span class="token number">35</span>      IN      A       <span class="token number">47.107</span>.188.168

<span class="token punctuation">;</span><span class="token punctuation">;</span> Query time: <span class="token number">29</span> msec
<span class="token punctuation">;</span><span class="token punctuation">;</span> SERVER: <span class="token number">127.0</span>.0.1<span class="token comment">#30053(127.0.0.1)</span>
<span class="token punctuation">;</span><span class="token punctuation">;</span> WHEN: Tue May <span class="token number">11</span> <span class="token number">14</span>:02:41 CST <span class="token number">2021</span>
<span class="token punctuation">;</span><span class="token punctuation">;</span> MSG SIZE  rcvd: <span class="token number">69</span>

$ ./coredns -dns.port <span class="token number">30053</span>
.:30053
CoreDNS-1.8.3
linux/amd64, go1.16, <span class="token number">4293992</span>
<span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> <span class="token number">127.0</span>.0.1:42293 - <span class="token number">51799</span> <span class="token string">"A IN tinychen.com. udp 53 false 4096"</span> NOERROR qr,rd,ra <span class="token number">58</span> <span class="token number">0</span>.244014828s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>

<h1 id="3、systemd管理"><a href="#3、systemd管理" class="headerlink" title="3、systemd管理"></a>3、systemd管理</h1><p>coredns作为一个二进制执行文件，并没有向其他的如nginx、bind等服务提供种类繁多的进程控制（reload stop restart等等）选项，因此为了方便我们管理和在后台一直运行coredns，这里我们使用systemd对其进行管理，只需要编写一个systemd的unit文件即可：</p>
<div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">cat</span> /usr/lib/systemd/system/coredns.service
<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>CoreDNS
<span class="token assign-left variable">Documentation</span><span class="token operator">=</span>https://coredns.io/manual/toc/
<span class="token assign-left variable">After</span><span class="token operator">=</span>network.target

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token comment"># Type设置为notify时，服务会不断重启</span>
<span class="token comment"># 关于type的设置，可以参考https://www.freedesktop.org/software/systemd/man/systemd.service.html#Options</span>
<span class="token assign-left variable">Type</span><span class="token operator">=</span>simple
<span class="token assign-left variable">User</span><span class="token operator">=</span>root
<span class="token comment"># 指定运行端口和读取的配置文件</span>
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/home/coredns/coredns -dns.port<span class="token operator">=</span><span class="token number">53</span> -conf /home/coredns/Corefile
<span class="token assign-left variable">Restart</span><span class="token operator">=</span>on-failure

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>

<p>编写完成之后我们依次reload配置文件并且设置开机启动服务和开启服务，即可看到服务正常运行</p>
<div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ systemctl daemon-reload
$ systemctl <span class="token builtin class-name">enable</span> coredns.service
$ systemctl start coredns.service
$ systemctl status coredns.service
● coredns.service - CoreDNS
   Loaded: loaded <span class="token punctuation">(</span>/usr/lib/systemd/system/coredns.service<span class="token punctuation">;</span> enabled<span class="token punctuation">;</span> vendor preset: disabled<span class="token punctuation">)</span>
   Active: active <span class="token punctuation">(</span>running<span class="token punctuation">)</span> since Tue <span class="token number">2021</span>-05-11 <span class="token number">11</span>:29:53 CST<span class="token punctuation">;</span> 2h 37min ago
     Docs: https://coredns.io/manual/toc/
 Main PID: <span class="token number">131287</span> <span class="token punctuation">(</span>coredns<span class="token punctuation">)</span>
    Tasks: <span class="token number">10</span> <span class="token punctuation">(</span>limit: <span class="token number">49835</span><span class="token punctuation">)</span>
   Memory: <span class="token number">27</span>.3M
   CGroup: /system.slice/coredns.service
           └─131287 /home/coredns/coredns -dns.port<span class="token operator">=</span><span class="token number">53</span> -conf /home/coredns/Corefile

May <span class="token number">11</span> <span class="token number">11</span>:29:53 tiny-server systemd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>: Started CoreDNS.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>

<h1 id="4、coredns日志处理"><a href="#4、coredns日志处理" class="headerlink" title="4、coredns日志处理"></a>4、coredns日志处理</h1><p>coredns的日志输出并不如nginx那么完善（并不能在配置文件中指定输出的文件目录，但是可以指定日志的格式），默认情况下不论是log插件还是error插件都会把所有的相关日志输出到程序的<code>standard output</code>中。使用systemd来管理coredns之后，默认情况下基本就是由<code>rsyslog</code>和<code>systemd-journald</code>这两个服务来管理日志。</p>
<h2 id="4-1-StandardOutput"><a href="#4-1-StandardOutput" class="headerlink" title="4.1 StandardOutput"></a>4.1 StandardOutput</h2><p>根据网上的<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/37585758/how-to-redirect-output-of-systemd-service-to-a-file">参考资料</a>我们可以得知较新版本的systemd是可以直接在systemd的unit文件里面配置<code>StandardOutput</code>和<code>StandardError</code>两个参数来将相关运行日志输出到指定的文件中。</p>
<p><img src="https://resource.tinychen.com/20210511112440.png" srcset="/img/loading.gif" lazyload></p>
<p>因此对于centos8等较新的系统，我们的unit文件可以这样编写：</p>
<div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>CoreDNS
<span class="token assign-left variable">Documentation</span><span class="token operator">=</span>https://coredns.io/manual/toc/
<span class="token assign-left variable">After</span><span class="token operator">=</span>network.target
<span class="token comment"># StartLimit这两个相关参数也是centos8等systemd版本较新的系统才支持的</span>
<span class="token assign-left variable">StartLimitBurst</span><span class="token operator">=</span><span class="token number">1</span>
<span class="token assign-left variable">StartLimitIntervalSec</span><span class="token operator">=</span>15s

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token comment"># Type设置为notify时，服务会不断重启</span>
<span class="token assign-left variable">Type</span><span class="token operator">=</span>simple
<span class="token assign-left variable">User</span><span class="token operator">=</span>root
<span class="token comment"># 指定运行端口和读取的配置文件</span>
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/home/coredns/coredns -dns.port<span class="token operator">=</span><span class="token number">53</span> -conf /home/coredns/Corefile
<span class="token comment"># append类型可以在原有文件末尾继续追加内容，而file类型则是重新打开一个新文件</span>
<span class="token comment"># 两者的区别类似于 echo >> 和 echo ></span>
<span class="token assign-left variable">StandardOutput</span><span class="token operator">=</span>append:/home/coredns/logs/coredns.log
<span class="token assign-left variable">StandardError</span><span class="token operator">=</span>append:/home/coredns/logs/coredns_error.log
<span class="token assign-left variable">Restart</span><span class="token operator">=</span>on-failure

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>

<blockquote>
<p>参考链接：<a target="_blank" rel="noopener" href="https://www.freedesktop.org/software/systemd/man/systemd.exec.html#StandardOutput=">systemd.exec (www.freedesktop.org)</a></p>
<p>The <code>file:*</code>path<code>*</code> option may be used to connect a specific file system object to standard output. The semantics are similar to the same option of <code>StandardInput=</code>, see above. If <em><code>path</code></em> refers to a regular file on the filesystem, it is opened (created if it doesn’t exist yet) for writing at the beginning of the file, but without truncating it. If standard input and output are directed to the same file path, it is opened only once, for reading as well as writing and duplicated. This is particularly useful when the specified path refers to an <code>AF_UNIX</code> socket in the file system, as in that case only a single stream connection is created for both input and output.</p>
<p><code>append:*</code>path<code>*</code> is similar to <code>file:*</code>path<code>*</code> above, but it opens the file in append mode.</p>
</blockquote>
<p>修改完成之后我们再重启服务就可以看到日志已经被重定向输出到我们指定的文件中</p>
<div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ systemctl daemon-reload
$ systemctl restart coredns.service<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></div>

<h2 id="4-2-rsyslog"><a href="#4-2-rsyslog" class="headerlink" title="4.2 rsyslog"></a>4.2 rsyslog</h2><p>对于centos7等系统而言，是不支持上面的append和file两个参数的，那么在开启了<code>rsyslog.service</code>服务的情况下，日志就会输出到<code>/var/log/messages</code>文件中，或者可以使用<code>journalctl -u coredns</code>命令来查看全部的日志。</p>
<p>如果想要将coredns的日志全部集中到一个文件进行统一管理，我们可以对负责管理<code>systemd</code>的日志的<code>rsyslog</code>服务的配置进行修改：</p>
<div class="code-wrapper"><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># vim /etc/rsyslog.conf</span>
<span class="token keyword">if</span> <span class="token variable">$programname</span> <span class="token operator">==</span> <span class="token string">'coredns'</span> <span class="token keyword">then</span> /home/coredns/logs/coredns.log
<span class="token operator">&amp;</span> stop

$ systemctl restart rsyslog.service<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></div>

<p><img src="https://resource.tinychen.com/20210511145618.png" srcset="/img/loading.gif" lazyload></p>
<p>从上图我们可以看到两种方式打出来的日志稍微有些不同，对于<code>StandardOutput</code>这种方式输出的日志缺少了前面的时间和主机名等信息，相对而言还是修改rsyslog的方式要更加的可靠。</p>

              
            </div>
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/network/" class="category-chain-item">network</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/dns/">#dns</a>
      
        <a href="/tags/coredns/">#coredns</a>
      
    </div>
  
</div>


              

              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/20210516-dns-04-coredns-02--install-external-plugins/" title="CoreDNS篇2-编译安装External Plugins">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">CoreDNS篇2-编译安装External Plugins</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/20210408-nmcli-create-net-bridge/" title="在centos中使用nmcli工具创建虚拟网桥">
                        <span class="hidden-mobile">在centos中使用nmcli工具创建虚拟网桥</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;Table of Contents</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  






    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">Keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <i class="iconfont icon-copyright"></i> <a href="https://tinychen.com/" target="_blank" rel="nofollow noopener"><span>2017~2022 By TinyChen </span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Hexo-Fluid</span></a> 
    </div>
  
  
  
    <!-- 备案信息 ICP for China -->
    <div class="beian">
  <span>
    <a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">
      粤ICP备18140640号
    </a>
  </span>
  
</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <!-- Baidu Analytics -->
    <script defer>
      if (!Fluid.ctx.dnt) {
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?7a96963a1145ac7fde1442d739a11ffd";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
      }
    </script>
  

  
    <!-- Google Analytics -->
    <script defer>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript('https://www.google-analytics.com/analytics.js', function() {
          window.ga = window.ga || function() { (ga.q = ga.q || []).push(arguments) };
          ga.l = +new Date;
          ga('create', 'UA-166769908-1', 'auto');
          ga('send', 'pageview');
        });
      }
    </script>
  

  

  

  

  

  




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.0/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script  src="https://lib.baomitu.com/prism/1.26.0/plugins/line-numbers/prism-line-numbers.min.js" ></script>

  <script>
  (function() {
    var enableLang = CONFIG.code_language.enable && CONFIG.code_language.default;
    var enableCopy = CONFIG.copy_btn;
    if (!enableLang && !enableCopy) {
      return;
    }

    function getBgClass(ele) {
      return Fluid.utils.getBackgroundLightness(ele) >= 0 ? 'code-widget-light' : 'code-widget-dark';
    }

    var copyTmpl = '';
    copyTmpl += '<div class="code-widget">';
    copyTmpl += 'LANG';
    copyTmpl += '</div>';
    jQuery('.markdown-body pre').each(function() {
      var $pre = jQuery(this);
      if ($pre.find('code.mermaid').length > 0) {
        return;
      }
      if ($pre.find('span.line').length > 0) {
        return;
      }

      var lang = '';

      if (enableLang) {
        lang = CONFIG.code_language.default;
        if ($pre[0].children.length > 0 && $pre[0].children[0].classList.length >= 2 && $pre.children().hasClass('hljs')) {
          lang = $pre[0].children[0].classList[1];
        } else if ($pre[0].getAttribute('data-language')) {
          lang = $pre[0].getAttribute('data-language');
        } else if ($pre.parent().hasClass('sourceCode') && $pre[0].children.length > 0 && $pre[0].children[0].classList.length >= 2) {
          lang = $pre[0].children[0].classList[1];
          $pre.parent().addClass('code-wrapper');
        } else if ($pre.parent().hasClass('markdown-body') && $pre[0].classList.length === 0) {
          $pre.wrap('<div class="code-wrapper"></div>');
        }
        lang = lang.toUpperCase().replace('NONE', CONFIG.code_language.default);
      }
      $pre.append(copyTmpl.replace('LANG', lang).replace('code-widget">',
        getBgClass($pre[0]) + (enableCopy ? ' code-widget copy-btn" data-clipboard-snippet><i class="iconfont icon-copy"></i>' : ' code-widget">')));

      if (enableCopy) {
        Fluid.utils.createScript('https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js', function() {
          var clipboard = new window.ClipboardJS('.copy-btn', {
            target: function(trigger) {
              var nodes = trigger.parentNode.childNodes;
              for (var i = 0; i < nodes.length; i++) {
                if (nodes[i].tagName === 'CODE') {
                  return nodes[i];
                }
              }
            }
          });
          clipboard.on('success', function(e) {
            e.clearSelection();
            e.trigger.innerHTML = e.trigger.innerHTML.replace('icon-copy', 'icon-success');
            setTimeout(function() {
              e.trigger.innerHTML = e.trigger.innerHTML.replace('icon-success', 'icon-copy');
            }, 2000);
          });
        });
      }
    });
  })();
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">Blog works best with JavaScript enabled</div>
  </noscript>
</body>
</html>
